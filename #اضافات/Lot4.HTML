<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ù„Ø§ØªØ§Ø±ÛŒ (Lottery Simulator) â€” Ù†Ø³Ø®Ù‡Ù” Ù¾Ø§ÛŒÙ‡</title>
<style>
  :root{
    --bg: #0f1115;
    --card:#161a22;
    --muted:#9aa4b2;
    --text:#eef2f7;
    --accent:#5eead4;
    --accent-2:#60a5fa;
    --danger:#ef4444;
    --ok:#10b981;
    --warn:#f59e0b;
    --border: #222737;
    --chip:#1f2430;
    --table-stripe:#141925;
  }
  [data-theme="light"]{
    --bg: #f6f7fb;
    --card:#ffffff;
    --muted:#5a6473;
    --text:#0f172a;
    --accent:#0ea5e9;
    --accent-2:#22c55e;
    --danger:#dc2626;
    --ok:#16a34a;
    --warn:#d97706;
    --border:#e5e7eb;
    --chip:#f3f4f6;
    --table-stripe:#f9fafb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font: 14px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", "Noto Sans", "Vazirmatn", Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  h1,h2,h3{margin:.2rem 0 .6rem}
  h1{font-size:1.35rem}
  h2{font-size:1.1rem}
  h3{font-size:1rem; color:var(--muted)}
  a{color:var(--accent)}
  .container{max-width:1200px; margin:0 auto; padding:16px}
  .toolbar{
    display:flex; gap:8px; align-items:center; justify-content:space-between;
    padding:10px 0 12px;
  }
  .row{display:grid; grid-template-columns: 340px 1fr; gap:16px}
  @media (max-width: 980px){
    .row{grid-template-columns: 1fr}
  }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px;
    box-shadow: 0 10px 25px rgba(0,0,0,.15);
  }
  .subgrid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .subgrid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  .muted{color:var(--muted)}
  .accent{color:var(--accent)}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .danger{color:var(--danger)}
  .chip{
    display:inline-flex; align-items:center; gap:6px; padding:.25rem .6rem; border-radius:9999px;
    background:var(--chip); border:1px solid var(--border); color:var(--muted); font-weight:600; font-size:12px;
  }

  label{display:block; font-weight:600; margin:.2rem 0 .25rem}
  input, select, button, textarea{
    width:100%; padding:.55rem .6rem; border-radius:10px; border:1px solid var(--border);
    background:var(--bg); color:var(--text); outline:none;
  }
  select{appearance:none; background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%), linear-gradient(135deg, var(--muted) 50%, transparent 50%), linear-gradient(to right, var(--muted), var(--muted));
    background-position: calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px), calc(100% - 2.5em) 0.4em;
    background-size: 5px 5px, 5px 5px, 1px 1.6em; background-repeat:no-repeat;
  }
  input[type="checkbox"], input[type="radio"]{width:auto}
  .controls{display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    cursor:pointer; font-weight:700; border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.08));
  }
  .btn.primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#081018; border:none}
  .btn.ghost{background:transparent}
  .btn.warn{background: linear-gradient(180deg, #f87171, #ef4444); color:#fff; border:none}
  .btn.secondary{background: linear-gradient(180deg, #a78bfa, #6366f1); color:#0b1020; border:none}
  .btn:disabled{opacity:.5; cursor:not-allowed}

  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  .grid-4{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
  .kpi{display:grid; grid-template-columns:repeat(6,1fr); gap:8px}
  @media (max-width: 980px){ .kpi{grid-template-columns:repeat(2,1fr)} }
  .kpi .item{padding:10px 12px; background:var(--chip); border:1px solid var(--border); border-radius:12px}
  .kpi .item .title{font-weight:700; color:var(--muted); font-size:12px}
  .kpi .item .value{font-size:1.1rem; font-weight:800; margin-top:2px}

  .table-wrap{overflow:auto; border-radius:10px; border:1px solid var(--border)}
  table{width:100%; border-collapse:separate; border-spacing:0}
  th, td{padding:8px 10px; text-align:center; border-bottom:1px solid var(--border)}
  tbody tr:nth-child(even){background:var(--table-stripe)}
  tr.win{background: rgba(16,185,129,.08)}
  tr.jp{background: rgba(99,102,241,.1)}
  .toolbar hr{border:none; border-top:1px solid var(--border); margin:8px 0}
  .small{font-size:12px}
  .flex{display:flex; gap:8px; align-items:center}
  .right{margin-inline-start:auto}
  .progress{height:8px; width:100%; background:var(--chip); border:1px solid var(--border); border-radius:99px; overflow:hidden}
  .progress .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2))}
  .target-box{display:flex; gap:6px; flex-wrap:wrap}
  .target-box input{width:64px; text-align:center; font-weight:700}
  .sep{height:1px; background:var(--border); margin:12px 0}
  .footer-note{color:var(--muted); font-size:12px; text-align:center; margin-top:16px}
  .rtl-toggle{margin-inline-start:8px}
  .pill{padding:.2rem .5rem; border-radius:999px; background:var(--chip); border:1px solid var(--border)}
  code.inline{background:var(--chip); padding:2px 6px; border-radius:6px; border:1px solid var(--border)}
  .hl{color:var(--accent)}
  .hint{font-size:12px; color:var(--muted)}
  canvas{display:block; width:100%; height:240px; background:var(--chip); border:1px solid var(--border); border-radius:10px}
</style>
</head>
<body data-theme="dark">
  <div class="container">
    <div class="toolbar">
      <div class="flex" style="flex-wrap:wrap">
        <h1>ğŸ¯ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ù„Ø§ØªØ§Ø±ÛŒ â€” <span class="muted">Ù†Ø³Ø®Ù‡Ù” Ù¾Ø§ÛŒÙ‡Ù” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</span></h1>
        <span class="chip">RTL</span>
        <span class="chip">Batch updates</span>
        <span class="chip">LocalStorage</span>
        <span class="chip">CSV</span>
        <span class="chip">Canvas Chart</span>
      </div>
      <div class="flex">
        <button id="themeToggle" class="btn">ğŸŒ“ ØªØºÛŒÛŒØ± ØªÙ…</button>
        <button id="dirToggle" class="btn rtl-toggle">â†”ï¸ RTL/LTR</button>
      </div>
    </div>

    <div class="row">
      <!-- SETTINGS -->
      <section id="settings" class="card">
        <h2>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
        <div class="grid-2">
          <div>
            <label for="preset">Ù¾Ø±ÛŒØ³Øª</label>
            <select id="preset"></select>
          </div>
          <div>
            <label for="ticketPrice">Ù‚ÛŒÙ…Øª Ø¨Ù„ÛŒØ· (ÙˆØ§Ø­Ø¯)</label>
            <input type="number" id="ticketPrice" min="0" step="1" />
          </div>
          <div>
            <label for="maxNumber">Ø¨Ø§Ø²Ù‡Ù” Ø§ØµÙ„ÛŒ (Û± ØªØ§ N)</label>
            <input type="number" id="maxNumber" min="1" step="1" />
          </div>
          <div>
            <label for="numbersPerTicket">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¯Ø§Ø¯ Ø¯Ø± Ù‡Ø± Ø¨Ù„ÛŒØ· (K)</label>
            <input type="number" id="numbersPerTicket" min="1" step="1" />
          </div>

          <div>
            <label for="bonusCount">ØªØ¹Ø¯Ø§Ø¯ Ø¨ÙˆÙ†Ø³</label>
            <input type="number" id="bonusCount" min="0" step="1" />
          </div>
          <div>
            <label for="bonusPool">Ø§Ø³ØªØ®Ø± Ø¨ÙˆÙ†Ø³ (Û± ØªØ§ M)</label>
            <input type="number" id="bonusPool" min="0" step="1" />
          </div>
        </div>

        <div class="sep"></div>

        <h3>ğŸ¯ ØªØ§Ø±Ú¯Øª (Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ)</h3>
        <div class="grid-2">
          <div>
            <label>Ø­Ø§Ù„Øª ØªØ§Ø±Ú¯Øª</label>
            <select id="targetMode">
              <option value="random">Ø±Ù†Ø¯ÙˆÙ…</option>
              <option value="manual">Ø¯Ø³ØªÛŒ</option>
            </select>
          </div>
          <div class="flex">
            <button id="genTarget" class="btn secondary right">ğŸ² ØªÙˆÙ„ÛŒØ¯ ØªØ§Ø±Ú¯Øª ØªØµØ§Ø¯ÙÛŒ</button>
          </div>
        </div>
        <div class="target-box" id="targetMainBox"></div>
        <div class="target-box" id="targetBonusBox"></div>
        <div class="hint">Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø±ÙˆØ²Ø§Ù†Ù‡ØŒ Ø§Ú¯Ø± Â«ØªØ§Ø±Ú¯Øª Ø±Ù†Ø¯ÙˆÙ…Â» ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ² ØªØ§Ø±Ú¯Øª Ø¬Ø¯ÛŒØ¯ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>

        <div class="sep"></div>

        <h3>ğŸ“† Ø­Ø§Ù„Øª Ø±ÙˆØ²Ø§Ù†Ù‡ (Daily Draw)</h3>
        <div class="grid-3">
          <div>
            <label for="ticketsPerDay">ØªØ¹Ø¯Ø§Ø¯ Ø¨Ù„ÛŒØ· Ø¯Ø± Ø±ÙˆØ²</label>
            <input type="number" id="ticketsPerDay" min="1" value="10" />
          </div>
          <div>
            <label for="totalTickets">Ú©Ù„ Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ</label>
            <input type="number" id="totalTickets" min="1" value="1000" />
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-top:22px">
            <input type="checkbox" id="changeTargetDaily" checked />
            <label for="changeTargetDaily" style="margin:0">ØªØ§Ø±Ú¯Øª Ø±ÙˆØ²Ø§Ù†Ù‡ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯</label>
          </div>
        </div>

        <div class="sep"></div>
        <h3>ğŸ¯ ÙÛŒÙ„ØªØ± Ø¨Ø§Ø²Ù‡Ù” ØªÙˆÙ„ÛŒØ¯ Ø¨Ù„ÛŒØ·</h3>
        <div class="grid-3">
          <div><label for="rangeMin">Ø§Ø²</label><input id="rangeMin" type="number" min="1" value="1"></div>
          <div><label for="rangeMax">ØªØ§</label><input id="rangeMax" type="number" min="1" value="70"></div>
          <div>
            <label for="rangeMode">Ø­Ø§Ù„Øª ÙÛŒÙ„ØªØ±</label>
            <select id="rangeMode">
              <option value="all">Ù‡Ù…Ù‡Ù” Ø§Ø¹Ø¯Ø§Ø¯ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡</option>
              <option value="any">Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¹Ø¯Ø¯ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡</option>
              <option value="off">Ø®Ø§Ù…ÙˆØ´</option>
            </select>
          </div>
        </div>
        <div class="hint">Ø¨Ø±Ø§ÛŒ Â«Ù‡Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡Â»ØŒ Ø¨Ø§ÛŒØ¯ Ø¹Ø±Ø¶ Ø¨Ø§Ø²Ù‡ â‰¥ K Ø¨Ø§Ø´Ø¯Ø› Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ù‡Ø´Ø¯Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</div>

        <div class="sep"></div>
        <h3>ğŸ’° Ø¬ÙˆØ§ÛŒØ² Ùˆ ØªØ·Ø§Ø¨Ù‚â€ŒÙ‡Ø§</h3>
        <div id="prizeTableWrap" class="table-wrap small"></div>
        <div class="controls" style="margin-top:8px">
          <button id="resetPrizeToPreset" class="btn">â†©ï¸ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¬ÙˆØ§ÛŒØ² Ø¨Ù‡ Ù¾Ø±ÛŒØ³Øª</button>
        </div>

        <div class="sep"></div>
        <h3>âš¡ï¸ Ú©Ø§Ø±Ø§ÛŒÛŒ</h3>
        <div class="grid-3">
          <div><label for="batchSize">Batch Update (Ù‡Ø± Ú†Ù†Ø¯ Ø¨Ù„ÛŒØ· ÛŒÚ© Ø¨Ø§Ø± UI)</label><input id="batchSize" type="number" min="1" value="100"></div>
          <div><label for="speedMs">ØªØ§Ø®ÛŒØ± Ø¨ÛŒÙ† Batch (ms)</label><input id="speedMs" type="number" min="0" value="0"></div>
          <div style="display:flex; align-items:center; gap:8px; margin-top:22px">
            <input type="checkbox" id="stopOnJackpot" />
            <label for="stopOnJackpot" style="margin:0">ØªÙˆÙ‚Ù Ø¯Ø± Ø¬Ú©â€ŒÙ¾Ø§Øª</label>
          </div>
        </div>
      </section>

      <!-- MAIN -->
      <section class="card">
        <div class="flex" style="justify-content:space-between">
          <h2>ğŸ“Š Ø¢Ù…Ø§Ø± Ø²Ù†Ø¯Ù‡</h2>
          <div class="controls">
            <button id="startBtn" class="btn primary">â–¶ï¸ Ø´Ø±ÙˆØ¹</button>
            <button id="pauseBtn" class="btn">â¸ï¸ ØªÙˆÙ‚Ù/Ø§Ø¯Ø§Ù…Ù‡</button>
            <button id="resetBtn" class="btn warn">ğŸ—‘ï¸ Ø±ÛŒØ³Øª</button>
          </div>
        </div>

        <div class="kpi" id="kpiRow">
          <div class="item"><div class="title">Tickets simulated</div><div class="value" id="k_tickets">0</div></div>
          <div class="item"><div class="title">Days simulated</div><div class="value" id="k_days">0</div></div>
          <div class="item"><div class="title">Jackpots</div><div class="value hl" id="k_jackpots">0</div></div>
          <div class="item"><div class="title">Total spent</div><div class="value" id="k_spent">0</div></div>
          <div class="item"><div class="title">Total paid</div><div class="value" id="k_paid">0</div></div>
          <div class="item"><div class="title">Net P/L</div><div class="value" id="k_net">0</div></div>
        </div>

        <div class="grid-2" style="margin-top:12px">
          <div class="card" style="padding:10px">
            <h3>ğŸ“ˆ Ù†Ù…ÙˆØ¯Ø§Ø± Ø²Ù†Ø¯Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† (Canvas)</h3>
            <canvas id="profitChart" width="600" height="260" aria-label="Profit chart"></canvas>
            <div class="small muted">Ù‡Ø± Ù†Ù‚Ø·Ù‡ = ÛŒÚ© Batch. Ù…Ø­ÙˆØ± Ø§ÙÙ‚ÛŒ: Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§ØŒ Ù…Ø­ÙˆØ± Ø¹Ù…ÙˆØ¯ÛŒ: Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† ØªØ¬Ù…Ø¹ÛŒ.</div>
          </div>
          <div class="card" style="padding:10px">
            <h3>ğŸ“† ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡</h3>
            <div class="grid-3">
              <div><div class="title">Ø±ÙˆØ² ÙØ¹Ù„ÛŒ</div><div class="value" id="d_day">1</div></div>
              <div><div class="title">Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div><div class="value" id="d_today">0</div></div>
              <div><div class="title">Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div><div class="value" id="d_wins">0</div></div>
            </div>
            <div class="sep"></div>
            <div class="progress"><div class="bar" id="progressBar"></div></div>
            <div class="small muted" id="progressText"></div>
            <div class="sep"></div>
            <div class="controls">
              <button id="exportCsv" class="btn">â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ CSV Ù„Ø§Ú¯</button>
              <button id="saveSession" class="btn">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡Ù” Ø¬Ù„Ø³Ù‡</button>
              <select id="sessionList" style="max-width:240px"></select>
              <button id="loadSession" class="btn">ğŸ“¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ù„Ø³Ù‡</button>
              <button id="clearStorage" class="btn ghost">ğŸ§¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ LocalStorage</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="flex" style="justify-content:space-between">
          <h2>ğŸ“œ Ù„Ø§Ú¯ Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§</h2>
          <div class="controls">
            <label class="flex"><input type="checkbox" id="filterWins" /> ÙÙ‚Ø· Ø¨Ø±Ø¯Ù‡Ø§</label>
            <input id="searchLog" placeholder="Ø¬Ø³ØªØ¬Ùˆ (Ø´Ù…Ø§Ø±Ù‡/Ù¾Ø±ÛŒØ³Øª/Ø±ÙˆØ²)..." />
            <select id="displayLimit" title="ØªØ¹Ø¯Ø§Ø¯ Ù†Ù…Ø§ÛŒØ´">
              <option value="300">Ù†Ù…Ø§ÛŒØ´ Û³Û°Û° ØªØ§ÛŒ Ø¢Ø®Ø±</option>
              <option value="1000">Ù†Ù…Ø§ÛŒØ´ Û±Û°Û°Û° ØªØ§ÛŒ Ø¢Ø®Ø±</option>
              <option value="1000000">Ù‡Ù…Ù‡</option>
            </select>
          </div>
        </div>
        <div class="table-wrap" id="logTableWrap"></div>
      </section>
    </div>

    <p class="footer-note">
      Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø¨Ø§ HTML, CSS, JS â€” Ø¨Ø¯ÙˆÙ† Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡Ù” Ø®Ø§Ø±Ø¬ÛŒ. Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø¹Ø¯Ø§Ø¯: <code class="inline">Fisherâ€“Yates Shuffle</code>. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ø¬Ù„Ø³Ø§Øª Ø¯Ø± <code class="inline">localStorage</code>.
    </p>

    <details class="card" style="margin-top:14px">
      <summary><strong>ğŸ“˜ README â€” Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ùˆ Ù…Ù†Ø·Ù‚ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ</strong></summary>
      <ol>
        <li><strong>Ø§Ø¬Ø±Ø§:</strong> ÙØ§ÛŒÙ„ <code>index.html</code> Ø±Ø§ Ø¨Ø§ Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯. Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù†Ø¯Ø§Ø±Ø¯. (Ø¯Ø± ØµÙˆØ±Øª ØªÙ…Ø§ÛŒÙ„ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±ÙˆÛŒ Ù‡Ø± Ù‡Ø§Ø³Øª Ø³Ø§Ø¯Ù‡ ÛŒØ§ Ø³Ø±ÙˆÛŒØ³ Ø§Ø³ØªØ§ØªÛŒÚ© Ù†ÛŒØ² Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.)</li>
        <li><strong>Ù¾Ø±ÛŒØ³Øªâ€ŒÙ‡Ø§:</strong> Ø§Ø² Ù…Ù†ÙˆÛŒ Â«Ù¾Ø±ÛŒØ³ØªÂ» ÛŒÚ©ÛŒ Ø§Ø² Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ù‚Ø§Ø¯ÛŒØ± <em>N, K, bonusCount, bonusPool, ticketPrice, prizeMap</em> ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯. Ø¬Ø¯ÙˆÙ„ Ø¬ÙˆØ§ÛŒØ² Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø³Øª.</li>
        <li><strong>ØªØ§Ø±Ú¯Øª:</strong> Ø¯Ø± Ø­Ø§Ù„Øª Â«Ø±Ù†Ø¯ÙˆÙ…Â»ØŒ ØªØ§Ø±Ú¯Øª Ø¨Ø§ Ø¯Ú©Ù…Ù‡Ù” ğŸ² ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø§Ú¯Ø± Â«ØªØ§Ø±Ú¯Øª Ø±ÙˆØ²Ø§Ù†Ù‡ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯Â» Ø±ÙˆØ´Ù† Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù‡Ø± Ø±ÙˆØ² ØªØ§Ø±Ú¯Øª Ø¬Ø¯ÛŒØ¯ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¯Ø± Ø­Ø§Ù„Øª Â«Ø¯Ø³ØªÛŒÂ»ØŒ Ø§Ø¹Ø¯Ø§Ø¯ ØªØ§Ø±Ú¯Øª Ø±Ø§ Ø¯Ø± Ú©Ø§Ø¯Ø±Ù‡Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</li>
        <li><strong>Ø­Ø§Ù„Øª Ø±ÙˆØ²Ø§Ù†Ù‡:</strong> Ø¨Ø§ Â«ØªØ¹Ø¯Ø§Ø¯ Ø¨Ù„ÛŒØ· Ø¯Ø± Ø±ÙˆØ²Â»ØŒ Ù‡Ø± X Ø¨Ù„ÛŒØ· ÛŒÚ© Ø±ÙˆØ² Ø¬Ù„Ùˆ Ù…ÛŒâ€ŒØ±ÙˆÛŒØ¯. Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø±ÙˆØ² ÙØ¹Ù„ÛŒØŒ Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²ØŒ Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²) Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</li>
        <li><strong>ÙÛŒÙ„ØªØ± Ø¨Ø§Ø²Ù‡:</strong> Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø¨Ù„ÛŒØ· Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø´Ø±Ø· Ú©Ù†ÛŒØ¯ Â«Ù‡Ù…Ù‡Ù” Ø§Ø¹Ø¯Ø§Ø¯ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡Â» Ø¨Ø§Ø´Ù†Ø¯ØŒ ÛŒØ§ Â«Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ©ÛŒÂ». Ø§Ú¯Ø± Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†Ø¨Ø§Ø´Ø¯ (Ù…Ø«Ù„Ø§Ù‹ Ø¹Ø±Ø¶ Ø¨Ø§Ø²Ù‡ &lt; K)ØŒ Ù‡Ø´Ø¯Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
        <li><strong>Ù„Ø§Ú¯ Ùˆ Ø¢Ù…Ø§Ø±:</strong> Ø§Ø² Ù‡Ø± Ø¨Ù„ÛŒØ· Ø±Ú©ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (timestamp, numbers, matches, prizeØŒ ...). Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ (spent/paid/net) Ùˆ Ø´Ù…Ø§Ø±Ø´ ØªØ·Ø§Ø¨Ù‚â€ŒÙ‡Ø§ Ø²Ù†Ø¯Ù‡ Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</li>
        <li><strong>CSV:</strong> Ø¨Ø§ Ø¯Ú©Ù…Ù‡Ù” Â«Ø®Ø±ÙˆØ¬ÛŒ CSVÂ» ØªÙ…Ø§Ù… Ù„Ø§Ú¯ Ø¬Ø§Ø±ÛŒ Ø¨Ù‡â€ŒØµÙˆØ±Øª CSV Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ù…Ø´Ø®ØµØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ù‡Ø³ØªÙ†Ø¯.</li>
        <li><strong>Ø¹Ù…Ù„Ú©Ø±Ø¯:</strong> Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI Ù‡Ø± <em>Batch</em> (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 100) Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ Ø±Ù†Ø¯Ø± Ø³Ø±ÛŒØ¹ Ø¨Ù…Ø§Ù†Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØ§Ø®ÛŒØ± Ø¨ÛŒÙ† Batch Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.</li>
        <li><strong>Ù†Ù…ÙˆØ¯Ø§Ø± Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†:</strong> Ù†Ù…ÙˆØ¯Ø§Ø± Canvas Ø¨Ø¯ÙˆÙ† Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡Ù” Ø®Ø§Ø±Ø¬ÛŒØŒ Ù¾Ø³ Ø§Ø² Ù‡Ø± Batch ÛŒÚ© Ù†Ù‚Ø·Ù‡Ù” Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ù†Ø­Ù†ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</li>
        <li><strong>Ø°Ø®ÛŒØ±Ù‡Ù” Ø¬Ù„Ø³Ù‡:</strong> Ø¨Ø§ Â«Ø°Ø®ÛŒØ±Ù‡Ù” Ø¬Ù„Ø³Ù‡Â» Ø®Ù„Ø§ØµÙ‡Ù” Ø¬Ù„Ø³Ù‡ (Ø¢Ù…Ø§Ø± Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª) Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø§Ø² Ù„ÛŒØ³Øª Ø¬Ù„Ø³Ø§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø³Øª. (Ø¨Ø±Ø§ÛŒ Ø­Ø¬Ù… Ø²ÛŒØ§Ø¯ØŒ ÙÙ‚Ø· Ø®Ù„Ø§ØµÙ‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„ Ø±Ø§ Ø¨Ù‡ CSV Ø¨Ú¯ÛŒØ±ÛŒØ¯.)</li>
      </ol>
    </details>
  </div>

<script>
(() => {
  // â€”â€”â€”â€”â€”â€”â€”â€” Data â€”â€”â€”â€”â€”â€”â€”â€”
  const PRESETS = {
    "Mega Millions": {
      name: "Mega Millions", n: 70, k: 5, bonusCount: 1, bonusPool: 25, ticketPrice: 2000,
      prizeMap: { "2":500, "3":10000, "4":50000, "5":1000000, "2+1":2000, "3+1":50000, "4+1":200000, "5+1":50000000 }
    },
    "Powerball": {
      name: "Powerball", n: 69, k: 5, bonusCount: 1, bonusPool: 26, ticketPrice: 2000,
      prizeMap: { "2":500, "3":10000, "4":50000, "5":1000000, "2+1":2000, "3+1":50000, "4+1":200000, "5+1":50000000 }
    },
    "EuroMillions": {
      name: "EuroMillions", n: 50, k: 5, bonusCount: 2, bonusPool: 12, ticketPrice: 2500,
      prizeMap: { "2":2000, "3":10000, "4":50000, "5":1000000, "2+1":5000, "3+1":20000, "4+1":100000, "5+1":5000000, "5+2":50000000 }
    },
    "Cash Five (TX)": {
      name: "Cash Five (TX)", n: 35, k: 5, bonusCount: 0, bonusPool: 0, ticketPrice: 1000,
      prizeMap: { "2":2000, "3":10000, "4":50000, "5":1000000 }
    },
    "Mini Lotto": {
      name: "Mini Lotto", n: 42, k: 5, bonusCount: 0, bonusPool: 0, ticketPrice: 1000,
      prizeMap: { "2":2000, "3":10000, "4":50000, "5":1000000 }
    },
    "Lotto 6/49": {
      name: "Lotto 6/49", n: 49, k: 6, bonusCount: 0, bonusPool: 0, ticketPrice: 2000,
      prizeMap: { "2":2000, "3":10000, "4":50000, "5":200000, "6":1000000 }
    },
    "Custom": {
      name: "Custom", n: 49, k: 6, bonusCount: 0, bonusPool: 0, ticketPrice: 1000, prizeMap: {}
    }
  };

  // â€”â€”â€”â€”â€”â€”â€”â€” State â€”â€”â€”â€”â€”â€”â€”â€”
  let state = {
    presetName: "Mega Millions",
    n: 70, k: 5, bonusCount: 1, bonusPool: 25,
    ticketPrice: 2000,
    prizeMap: {},
    targetMode: "random",
    targetMain: [],
    targetBonus: [],
    ticketsPerDay: 10,
    totalTickets: 1000,
    changeTargetDaily: true,
    rangeMode: "off",
    rangeMin: 1, rangeMax: 70,
    batchSize: 100, speedMs: 0,
    stopOnJackpot: false,

    // runtime
    sessionId: null,
    isRunning: false, isPaused: false,
    todayTickets: 0, day: 1, todayWins: 0,
    progress: 0,

    stats: {
      tickets: 0, days: 0, jackpots: 0,
      spent: 0, paid: 0, net: 0,
      matchCounts: {} // dynamic keys like "2", "3+1", ...
    },

    // log
    rows: [],               // full log in-memory (display is windowed)
    displayLimit: 300,      // how many last rows to render into table
    winsOnly: false,
    searchTerm: ""
  };

  const els = {
    preset: $("#preset"),
    ticketPrice: $("#ticketPrice"),
    maxNumber: $("#maxNumber"),
    numbersPerTicket: $("#numbersPerTicket"),
    bonusCount: $("#bonusCount"),
    bonusPool: $("#bonusPool"),
    targetMode: $("#targetMode"),
    genTarget: $("#genTarget"),
    targetMainBox: $("#targetMainBox"),
    targetBonusBox: $("#targetBonusBox"),

    ticketsPerDay: $("#ticketsPerDay"),
    totalTickets: $("#totalTickets"),
    changeTargetDaily: $("#changeTargetDaily"),

    rangeMin: $("#rangeMin"),
    rangeMax: $("#rangeMax"),
    rangeMode: $("#rangeMode"),

    prizeTableWrap: $("#prizeTableWrap"),
    resetPrizeToPreset: $("#resetPrizeToPreset"),

    batchSize: $("#batchSize"),
    speedMs: $("#speedMs"),
    stopOnJackpot: $("#stopOnJackpot"),

    startBtn: $("#startBtn"),
    pauseBtn: $("#pauseBtn"),
    resetBtn: $("#resetBtn"),

    k_tickets: $("#k_tickets"),
    k_days: $("#k_days"),
    k_jackpots: $("#k_jackpots"),
    k_spent: $("#k_spent"),
    k_paid: $("#k_paid"),
    k_net: $("#k_net"),

    d_day: $("#d_day"),
    d_today: $("#d_today"),
    d_wins: $("#d_wins"),

    progressBar: $("#progressBar"),
    progressText: $("#progressText"),

    exportCsv: $("#exportCsv"),
    saveSession: $("#saveSession"),
    sessionList: $("#sessionList"),
    loadSession: $("#loadSession"),
    clearStorage: $("#clearStorage"),

    logTableWrap: $("#logTableWrap"),
    filterWins: $("#filterWins"),
    searchLog: $("#searchLog"),
    displayLimit: $("#displayLimit"),

    themeToggle: $("#themeToggle"),
    dirToggle: $("#dirToggle"),

    profitChart: $("#profitChart"),
  };

  // â€”â€”â€”â€”â€”â€”â€”â€” Utils â€”â€”â€”â€”â€”â€”â€”â€”
  function $(sel){ return document.querySelector(sel); }
  function create(tag, attrs={}, html=""){ const el=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>el.setAttribute(k,v)); if(html) el.innerHTML=html; return el; }
  const fmt = (x) => (x|0).toLocaleString("fa-IR");
  const nowIso = () => new Date().toISOString();
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  function fisherYatesShuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function sampleUnique(max, count){
    const a = Array.from({length:max}, (_,i)=>i+1);
    fisherYatesShuffle(a);
    return a.slice(0, count).sort((a,b)=>a-b);
  }
  function setEquals(a,b){
    if(a.length!==b.length) return false;
    for(let i=0;i<a.length;i++) if(a[i]!==b[i]) return false;
    return true;
  }
  function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

  // â€”â€”â€”â€”â€”â€”â€”â€” Prize Table (dynamic rows) â€”â€”â€”â€”â€”â€”â€”â€”
  function buildPrizeKeys(k, bonusCount){
    const keys = [];
    for(let m=2; m<=k; m++){
      keys.push(String(m));
      for(let b=1; b<=bonusCount; b++){
        keys.push(`${m}+${b}`);
      }
    }
    return keys;
  }
  function renderPrizeTable(){
    const keys = buildPrizeKeys(state.k, state.bonusCount);
    // Merge current prizeMap with zeros for missing keys
    for(const key of keys){
      if(!(key in state.prizeMap)) state.prizeMap[key]=0;
    }
    const tbl = [];
    tbl.push(`<table><thead><tr>
      <th>ØªØ·Ø§Ø¨Ù‚</th><th>Ø¬Ø§ÛŒØ²Ù‡</th></tr></thead><tbody>`);
    const sorted = keys.slice().sort((a,b)=>{
      // Ensure jackpot row is last visually? we'll sort descending by m, then b
      const [am,ab] = a.split("+").map(x=>parseInt(x)||0);
      const [bm,bb] = b.split("+").map(x=>parseInt(x)||0);
      if(am!==bm) return bm-am;
      return (bb-ab);
    });
    for(const key of sorted){
      const val = state.prizeMap[key]||0;
      tbl.push(`<tr>
        <td><strong>${key}</strong>${isJackKey(key) ? ' <span class="pill">Ø¬Ú©â€ŒÙ¾Ø§Øª</span>' : ''}</td>
        <td><input class="prize-input" data-key="${key}" type="number" step="1" min="0" value="${val}"/></td>
      </tr>`);
    }
    tbl.push(`</tbody></table>`);
    els.prizeTableWrap.innerHTML = tbl.join("");
    els.prizeTableWrap.querySelectorAll(".prize-input").forEach(inp=>{
      inp.addEventListener("change", e=>{
        const key = e.target.dataset.key;
        state.prizeMap[key] = parseInt(e.target.value||"0",10);
        persistSettings();
      });
    });
  }
  function isJackKey(key){
    const [m,b=0] = key.split("+").map(x=>parseInt(x)||0);
    return m===state.k && b===state.bonusCount && state.bonusCount>0 || (state.bonusCount===0 && m===state.k);
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Target UI â€”â€”â€”â€”â€”â€”â€”â€”
  function renderTargetInputs(){
    els.targetMainBox.innerHTML="";
    els.targetBonusBox.innerHTML="";
    const mk = (parent, count, label) => {
      const frag = document.createDocumentFragment();
      const span = create("div", {}, `<div class="muted">${label}</div>`);
      frag.appendChild(span);
      for(let i=0;i<count;i++){
        const input = create("input", {type:"number", min:"1", step:"1"});
        input.addEventListener("change", ()=>{
          if(parent===els.targetMainBox) state.targetMain[i]=parseInt(input.value||"0",10);
          else state.targetBonus[i]=parseInt(input.value||"0",10);
          persistSettings();
        });
        frag.appendChild(input);
      }
      parent.appendChild(frag);
    };
    mk(els.targetMainBox, state.k, "Ø§Ø¹Ø¯Ø§Ø¯ Ø§ØµÙ„ÛŒ (K)");
    if(state.bonusCount>0) mk(els.targetBonusBox, state.bonusCount, "Ø¨ÙˆÙ†Ø³");
    syncTargetInputs();
  }
  function syncTargetInputs(){
    Array.from(els.targetMainBox.querySelectorAll("input")).forEach((inp,idx)=> inp.value = state.targetMain[idx]||"");
    Array.from(els.targetBonusBox.querySelectorAll("input")).forEach((inp,idx)=> inp.value = state.targetBonus[idx]||"");
  }
  function randomizeTarget(){
    state.targetMain = sampleUnique(state.n, state.k);
    if(state.bonusCount>0) state.targetBonus = sampleUnique(state.bonusPool, state.bonusCount);
    else state.targetBonus = [];
    syncTargetInputs();
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Settings & Presets â€”â€”â€”â€”â€”â€”â€”â€”
  function loadPresetOptions(){
    els.preset.innerHTML = Object.keys(PRESETS).map(name=>`<option value="${name}">${name}</option>`).join("");
  }
  function applyPreset(name){
    const p = deepClone(PRESETS[name]);
    state.presetName = p.name;
    state.n = p.n; state.k = p.k; state.bonusCount = p.bonusCount; state.bonusPool = p.bonusPool;
    state.ticketPrice = p.ticketPrice;
    state.prizeMap = deepClone(p.prizeMap || {});
    // range defaults
    state.rangeMin = 1; state.rangeMax = p.n; state.rangeMode = "off";
    // target defaults
    if(state.targetMode==="random") randomizeTarget();
    // reflect UI
    els.preset.value = name;
    els.maxNumber.value = state.n;
    els.numbersPerTicket.value = state.k;
    els.bonusCount.value = state.bonusCount;
    els.bonusPool.value = state.bonusPool;
    els.ticketPrice.value = state.ticketPrice;
    els.rangeMin.value = state.rangeMin;
    els.rangeMax.value = state.rangeMax;
    els.rangeMode.value = state.rangeMode;
    renderPrizeTable();
    renderTargetInputs();
    persistSettings();
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” LocalStorage â€”â€”â€”â€”â€”â€”â€”â€”
  const LS_SETTINGS = "lotto.settings.v1";
  const LS_SESSIONS = "lotto.sessions.v1";
  function persistSettings(){
    const toSave = {
      presetName: state.presetName,
      n: state.n, k: state.k, bonusCount: state.bonusCount, bonusPool: state.bonusPool,
      ticketPrice: state.ticketPrice,
      prizeMap: state.prizeMap,
      targetMode: state.targetMode,
      targetMain: state.targetMain, targetBonus: state.targetBonus,
      ticketsPerDay: state.ticketsPerDay, totalTickets: state.totalTickets, changeTargetDaily: state.changeTargetDaily,
      rangeMin: state.rangeMin, rangeMax: state.rangeMax, rangeMode: state.rangeMode,
      batchSize: state.batchSize, speedMs: state.speedMs, stopOnJackpot: state.stopOnJackpot,
      theme: document.body.getAttribute("data-theme"),
      dir: document.documentElement.getAttribute("dir")
    };
    localStorage.setItem(LS_SETTINGS, JSON.stringify(toSave));
  }
  function restoreSettings(){
    const raw = localStorage.getItem(LS_SETTINGS);
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      Object.assign(state, s);
      // reflect UI
      els.preset.value = state.presetName;
      els.maxNumber.value = state.n;
      els.numbersPerTicket.value = state.k;
      els.bonusCount.value = state.bonusCount;
      els.bonusPool.value = state.bonusPool;
      els.ticketPrice.value = state.ticketPrice;

      els.targetMode.value = state.targetMode;
      els.ticketsPerDay.value = state.ticketsPerDay;
      els.totalTickets.value = state.totalTickets;
      els.changeTargetDaily.checked = state.changeTargetDaily;

      els.rangeMin.value = state.rangeMin;
      els.rangeMax.value = state.rangeMax;
      els.rangeMode.value = state.rangeMode;

      els.batchSize.value = state.batchSize;
      els.speedMs.value = state.speedMs;
      els.stopOnJackpot.checked = state.stopOnJackpot;

      if(s.theme) document.body.setAttribute("data-theme", s.theme);
      if(s.dir) document.documentElement.setAttribute("dir", s.dir);

      renderPrizeTable();
      renderTargetInputs();
      syncTargetInputs();
    }catch(e){}
  }

  function refreshSessionsSelect(){
    const raw = localStorage.getItem(LS_SESSIONS);
    let obj = {};
    try{ obj = JSON.parse(raw||"{}")}catch(e){}
    els.sessionList.innerHTML = `<option value="">Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯â€¦</option>`+
      Object.keys(obj).sort().reverse().map(id=>{
        const sess = obj[id];
        return `<option value="${id}">${id} â€” ${sess.presetName} â€” tickets:${sess.stats?.tickets||0}</option>`;
      }).join("");
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Chart (Canvas) â€”â€”â€”â€”â€”â€”â€”â€”
  const chart = {
    ctx: els.profitChart.getContext("2d"),
    points: [], // {x: tickets, y: net}
    maxPoints: 2000,
  };
  function chartReset(){ chart.points.length=0; chartDraw(); }
  function chartAddPoint(tickets, net){
    chart.points.push({x:+tickets, y:+net});
    if(chart.points.length>chart.maxPoints) chart.points.shift();
    chartDraw();
  }
  function chartDraw(){
    const c = els.profitChart; const ctx = chart.ctx;
    ctx.clearRect(0,0,c.width,c.height);
    // padding
    const pad = {l:48, r:10, t:10, b:24};
    const w = c.width - pad.l - pad.r;
    const h = c.height - pad.t - pad.b;
    // scales
    const xs = chart.points.map(p=>p.x);
    const ys = chart.points.map(p=>p.y);
    const minX = xs.length? Math.min(...xs) : 0;
    const maxX = xs.length? Math.max(...xs) : 1;
    const minY = ys.length? Math.min(...ys) : -100;
    const maxY = ys.length? Math.max(...ys) : 100;
    // grid
    ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border');
    ctx.lineWidth=1;
    ctx.beginPath();
    for(let i=0;i<=5;i++){
      const y = pad.t + h*(i/5);
      ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+w, y);
    }
    ctx.stroke();

    // axes labels
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted');
    ctx.font = "12px ui-sans-serif";
    ctx.textAlign="right"; ctx.textBaseline="middle";
    ctx.fillText(fmt(maxY), pad.l-6, pad.t);
    ctx.fillText(fmt(minY), pad.l-6, pad.t+h);

    // line
    if(chart.points.length>1){
      ctx.beginPath();
      ctx.lineWidth=2;
      ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent-2');
      for(let i=0;i<chart.points.length;i++){
        const p = chart.points[i];
        const x = pad.l + w*( (p.x-minX)/(maxX-minX||1) );
        const y = pad.t + h*( 1 - (p.y-minY)/(maxY-minY||1) );
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Log Table â€”â€”â€”â€”â€”â€”â€”â€”
  function renderLog(){
    const rows = state.rows;
    // filter
    let filtered = rows;
    if(state.winsOnly) filtered = filtered.filter(r => r.prizeAmount>0);
    const q = (state.searchTerm||"").trim();
    if(q){
      const qq = q.toLowerCase();
      filtered = filtered.filter(r =>
        r.presetName.toLowerCase().includes(qq) ||
        r.timestamp.includes(qq) ||
        String(r.ticketIndex).includes(qq) ||
        r.numbersMain.join(",").includes(qq) ||
        (r.numbersBonus||[]).join(",").includes(qq) ||
        String(r.day).includes(qq) ||
        String(r.prizeAmount).includes(qq)
      );
    }
    // window last N
    const N = state.displayLimit;
    const view = filtered.slice(-N);
    // table
    const head = `<table><thead><tr>
      <th style="min-width:120px">timestamp</th>
      <th>sessionId</th>
      <th>#</th>
      <th>Day</th>
      <th>numbersMain</th>
      <th>numbersBonus</th>
      <th>matchedMain</th>
      <th>matchedBonus</th>
      <th>prize</th>
      <th>spent</th>
      <th>net</th>
      <th>preset</th>
    </tr></thead><tbody>`;
    const body = view.map(r=>{
      const cls = r.prizeAmount>0 ? (r.matchedMain===state.k && r.matchedBonus===state.bonusCount? "jp" : "win") : "";
      return `<tr class="${cls}">
        <td>${r.timestamp}</td>
        <td class="small">${r.sessionId}</td>
        <td>${r.ticketIndex}</td>
        <td>${r.day}</td>
        <td>${r.numbersMain.join(",")}</td>
        <td>${(r.numbersBonus||[]).join(",")}</td>
        <td>${r.matchedMain}</td>
        <td>${r.matchedBonus}</td>
        <td>${fmt(r.prizeAmount)}</td>
        <td>${fmt(r.spentAmount)}</td>
        <td>${fmt(r.netAmount)}</td>
        <td>${r.presetName}</td>
      </tr>`;
    }).join("");
    const foot = `</tbody></table>`;
    els.logTableWrap.innerHTML = head + body + foot;
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Stats UI â€”â€”â€”â€”â€”â€”â€”â€”
  function updateKPI(){
    els.k_tickets.textContent = fmt(state.stats.tickets);
    els.k_days.textContent = fmt(state.stats.days);
    els.k_jackpots.textContent = fmt(state.stats.jackpots);
    els.k_spent.textContent = fmt(state.stats.spent);
    els.k_paid.textContent  = fmt(state.stats.paid);
    const net = state.stats.paid - state.stats.spent;
    els.k_net.textContent   = fmt(net);
    els.k_net.style.color = net>=0 ? getComputedStyle(document.body).getPropertyValue('--ok') : getComputedStyle(document.body).getPropertyValue('--danger');

    els.d_day.textContent = state.day;
    els.d_today.textContent = state.todayTickets;
    els.d_wins.textContent = state.todayWins;
  }
  function updateProgress(){
    const pct = Math.floor((state.stats.tickets / state.totalTickets) * 100);
    els.progressBar.style.width = `${clamp(pct,0,100)}%`;
    els.progressText.textContent = `Ù¾ÛŒØ´Ø±ÙØª: ${pct}% â€” ${fmt(state.stats.tickets)}/${fmt(state.totalTickets)} Ø¨Ù„ÛŒØ·`;
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Matching & Prize â€”â€”â€”â€”â€”â€”â€”â€”
  function countMatches(arr, target){ // both sorted arrays
    let i=0,j=0,c=0;
    while(i<arr.length && j<target.length){
      if(arr[i]===target[j]){ c++; i++; j++; }
      else if(arr[i]<target[j]) i++; else j++;
    }
    return c;
  }
  function calcPrize(matchedMain, matchedBonus){
    // exact match keys prioritized (e.g., "3+1"), else fallback to pure main key ("3")
    const key2 = matchedBonus>0 ? `${matchedMain}+${matchedBonus}` : null;
    if(key2 && state.prizeMap[key2]!=null) return state.prizeMap[key2]|0;
    if(state.prizeMap[String(matchedMain)]!=null) return state.prizeMap[String(matchedMain)]|0;
    return 0;
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Ticket generation with Range Filter â€”â€”â€”â€”â€”â€”â€”â€”
  function isTicketInRange(main){
    if(state.rangeMode==="off") return true;
    const a = state.rangeMin|0, b = state.rangeMax|0;
    if(a>b) return true; // neutralize
    if(state.rangeMode==="all"){
      // all K must lie within [a,b]
      return main.every(x=>x>=a && x<=b);
    }else if(state.rangeMode==="any"){
      return main.some(x=>x>=a && x<=b);
    }
    return true;
  }
  function viableRange(){
    if(state.rangeMode!=="all") return true;
    const width = (state.rangeMax|0) - (state.rangeMin|0) + 1;
    return width >= state.k;
  }
  function generateTicket(){
    // rejection sampling with cap
    let tries = 0;
    while(true){
      tries++;
      const main = sampleUnique(state.n, state.k);
      if(isTicketInRange(main)) {
        const bonus = state.bonusCount>0 ? sampleUnique(state.bonusPool, state.bonusCount) : [];
        return {main, bonus};
      }
      if(tries>2000){
        // give up to avoid infinite loop
        return {main: sampleUnique(state.n, state.k), bonus: state.bonusCount>0 ? sampleUnique(state.bonusPool, state.bonusCount) : []};
      }
    }
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Simulation â€”â€”â€”â€”â€”â€”â€”â€”
  async function run(){
    if(state.isRunning) return;
    // validate
    if(state.rangeMode==="all" && !viableRange()){
      alert("âš ï¸ Ø¨Ø§Ø²Ù‡Ù” Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Â«Ù‡Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡Â» Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª (Ø¹Ø±Ø¶ Ø¨Ø§Ø²Ù‡ Ø¨Ø§ÛŒØ¯ â‰¥ K Ø¨Ø§Ø´Ø¯).");
      return;
    }
    state.isRunning = true; state.isPaused = false;
    // init session
    state.sessionId = `session-${new Date().toISOString().replace(/[-:TZ.]/g,"").slice(0,14)}`;
    state.stats = {tickets:0, days:0, jackpots:0, spent:0, paid:0, net:0, matchCounts:{}};
    state.rows.length = 0;
    state.day = 1; state.todayTickets = 0; state.todayWins = 0;
    chartReset();
    updateKPI(); updateProgress(); renderLog();

    // initialize target if needed
    if(state.targetMode==="random") randomizeTarget();
    state.stats.days = 1;

    const total = state.totalTickets|0;
    const B = Math.max(1, state.batchSize|0);
    const delay = Math.max(0, state.speedMs|0);

    for(let batchStart=0; batchStart<total; batchStart+=B){
      if(!state.isRunning) break;
      while(state.isPaused) { await sleep(80); }
      const batchEnd = Math.min(total, batchStart+B);
      // If starting a new day exactly at batch boundary, handle target change
      // We'll progress ticket-by-ticket inside batch to respect day boundaries
      for(let i=batchStart+1; i<=batchEnd; i++){
        if(!state.isRunning) break;
        // change day?
        if(state.todayTickets>= (state.ticketsPerDay|0)){
          state.stats.days++;
          state.day++;
          state.todayTickets = 0;
          state.todayWins = 0;
          if(state.changeTargetDaily && state.targetMode==="random") randomizeTarget();
        }
        // ticket
        const t = generateTicket();
        const m = countMatches(t.main, state.targetMain);
        const b = state.bonusCount>0 ? countMatches(t.bonus, state.targetBonus) : 0;
        const prize = calcPrize(m,b);
        const spent = state.ticketPrice|0;
        const net   = (prize|0) - (spent|0);

        state.stats.tickets++;
        state.todayTickets++;
        state.stats.spent += spent;
        state.stats.paid  += prize;
        state.stats.net    = state.stats.paid - state.stats.spent;

        // matchCounts
        const key = (b>0) ? `${m}+${b}` : String(m);
        if(!(key in state.stats.matchCounts)) state.stats.matchCounts[key]=0;
        state.stats.matchCounts[key]++;

        // jackpot
        const isJack = (state.bonusCount>0) ? (m===state.k && b===state.bonusCount) : (m===state.k);
        if(isJack){ state.stats.jackpots++; state.todayWins++; if(state.stopOnJackpot){ state.rows.push(rowObj(i,t,m,b,prize,spent,net)); finishBatchUI(i,batchEnd,true); stop(); return; } }
        if(prize>0) state.todayWins++;

        // log row
        state.rows.push( rowObj(i,t,m,b,prize,spent,net) );
      }
      // batch UI
      finishBatchUI(batchEnd, batchEnd, false);
      chartAddPoint(state.stats.tickets, state.stats.net);
      if(delay>0) await sleep(delay);
    }
    stop(); // auto-stop at the end
  }
  function finishBatchUI(done, batchEnd, stoppedByJackpot){
    updateKPI();
    updateProgress();
    renderLog();
  }
  function rowObj(i,t,m,b,prize,spent,net){
    return {
      timestamp: nowIso(),
      sessionId: state.sessionId,
      ticketIndex: i,
      day: state.day,
      numbersMain: t.main,
      numbersBonus: t.bonus,
      matchedMain: m, matchedBonus: b,
      prizeAmount: prize|0,
      spentAmount: spent|0,
      netAmount: net|0,
      presetName: state.presetName
    };
  }
  function stop(){ state.isRunning=false; state.isPaused=false; }
  function pause(){ state.isPaused = !state.isPaused; }

  const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

  // â€”â€”â€”â€”â€”â€”â€”â€” CSV â€”â€”â€”â€”â€”â€”â€”â€”
  function toCSV(){
    const header = "timestamp,sessionId,ticketIndex,day,numbersMain,numbersBonus,matchedMain,matchedBonus,prizeAmount,spentAmount,netAmount,presetName";
    const lines = state.rows.map(r=>{
      const nm = `"${r.numbersMain.join(",")}"`;
      const nb = `"${(r.numbersBonus||[]).join(",")}"`;
      return [
        r.timestamp, r.sessionId, r.ticketIndex, r.day, nm, nb, r.matchedMain, r.matchedBonus,
        r.prizeAmount, r.spentAmount, r.netAmount, `"${r.presetName}"`
      ].join(",");
    });
    return [header, ...lines].join("\n");
  }
  function download(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url; a.download = filename; a.style.display="none";
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  // â€”â€”â€”â€”â€”â€”â€”â€” Event bindings â€”â€”â€”â€”â€”â€”â€”â€”
  els.startBtn.addEventListener("click", run);
  els.pauseBtn.addEventListener("click", pause);
  els.resetBtn.addEventListener("click", ()=>{ stop(); applyPreset(state.presetName); state.rows.length=0; state.stats={tickets:0,days:1,jackpots:0,spent:0,paid:0,net:0,matchCounts:{}}; state.day=1; state.todayTickets=0; state.todayWins=0; chartReset(); updateKPI(); updateProgress(); renderLog(); });

  els.exportCsv.addEventListener("click", ()=>{
    if(state.rows.length===0){ alert("Ù„Ø§Ú¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯."); return; }
    download(`lotto-${state.sessionId||"session"}.csv`, toCSV());
  });

  els.saveSession.addEventListener("click", ()=>{
    const raw = localStorage.getItem(LS_SESSIONS);
    let obj = {}; try{ obj = JSON.parse(raw||"{}")}catch(e){}
    const id = state.sessionId || `manual-${Date.now()}`;
    obj[id] = {
      savedAt: nowIso(),
      presetName: state.presetName,
      settings: {
        n: state.n, k: state.k, bonusCount: state.bonusCount, bonusPool: state.bonusPool,
        ticketPrice: state.ticketPrice, rangeMode: state.rangeMode, rangeMin: state.rangeMin, rangeMax: state.rangeMax
      },
      stats: deepClone(state.stats)
    };
    localStorage.setItem(LS_SESSIONS, JSON.stringify(obj));
    refreshSessionsSelect();
    alert("âœ… Ø¬Ù„Ø³Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (Ø®Ù„Ø§ØµÙ‡Ù” Ø¢Ù…Ø§Ø± Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª). Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„ Ø§Ø² CSV Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.");
  });

  els.loadSession.addEventListener("click", ()=>{
    const id = els.sessionList.value;
    if(!id) { alert("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¬Ù„Ø³Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }
    const raw = localStorage.getItem(LS_SESSIONS);
    let obj = {}; try{ obj = JSON.parse(raw||"{}")}catch(e){}
    const sess = obj[id]; if(!sess){ alert("ÛŒØ§ÙØª Ù†Ø´Ø¯."); return; }
    // apply settings & stats (read-only import of stats)
    state.presetName = sess.presetName;
    els.preset.value = sess.presetName;
    const s = sess.settings||{};
    state.n=s.n; state.k=s.k; state.bonusCount=s.bonusCount; state.bonusPool=s.bonusPool; state.ticketPrice=s.ticketPrice;
    state.rangeMode=s.rangeMode; state.rangeMin=s.rangeMin; state.rangeMax=s.rangeMax;
    els.maxNumber.value=state.n; els.numbersPerTicket.value=state.k; els.bonusCount.value=state.bonusCount; els.bonusPool.value=state.bonusPool; els.ticketPrice.value=state.ticketPrice;
    els.rangeMode.value=state.rangeMode; els.rangeMin.value=state.rangeMin; els.rangeMax.value=state.rangeMax;
    renderPrizeTable(); renderTargetInputs(); syncTargetInputs();
    // show stats only (no log)
    state.stats = deepClone(sess.stats||{});
    state.day = state.stats.days||1; state.todayTickets=0; state.todayWins=0;
    chartReset(); chartAddPoint(state.stats.tickets, state.stats.net||0);
    updateKPI(); updateProgress(); renderLog();
    alert("Ø¬Ù„Ø³Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ (ÙÙ‚Ø· Ø¢Ù…Ø§Ø± Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª).");
  });

  els.clearStorage.addEventListener("click", ()=>{
    if(confirm("ØªÙ…Ø§Ù… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ø¬Ù„Ø³Ø§Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ")){ localStorage.removeItem(LS_SETTINGS); localStorage.removeItem(LS_SESSIONS); refreshSessionsSelect(); alert("Ù¾Ø§Ú© Ø´Ø¯."); }
  });

  // settings change handlers
  els.preset.addEventListener("change", ()=> applyPreset(els.preset.value));
  els.ticketPrice.addEventListener("change", ()=>{ state.ticketPrice=parseInt(els.ticketPrice.value||"0",10); persistSettings(); });
  els.maxNumber.addEventListener("change", ()=>{ state.n=parseInt(els.maxNumber.value||"0",10); persistSettings(); renderTargetInputs(); renderPrizeTable(); });
  els.numbersPerTicket.addEventListener("change", ()=>{ state.k=parseInt(els.numbersPerTicket.value||"0",10); persistSettings(); renderTargetInputs(); renderPrizeTable(); });
  els.bonusCount.addEventListener("change", ()=>{ state.bonusCount=parseInt(els.bonusCount.value||"0",10); persistSettings(); renderTargetInputs(); renderPrizeTable(); });
  els.bonusPool.addEventListener("change", ()=>{ state.bonusPool=parseInt(els.bonusPool.value||"0",10); persistSettings(); renderTargetInputs(); renderPrizeTable(); });

  els.targetMode.addEventListener("change", ()=>{ state.targetMode=els.targetMode.value; persistSettings(); });
  els.genTarget.addEventListener("click", ()=>{ randomizeTarget(); persistSettings(); });

  els.ticketsPerDay.addEventListener("change", ()=>{ state.ticketsPerDay=parseInt(els.ticketsPerDay.value||"0",10); persistSettings(); });
  els.totalTickets.addEventListener("change", ()=>{ state.totalTickets=parseInt(els.totalTickets.value||"0",10); persistSettings(); updateProgress(); });
  els.changeTargetDaily.addEventListener("change", ()=>{ state.changeTargetDaily=els.changeTargetDaily.checked; persistSettings(); });

  els.rangeMin.addEventListener("change", ()=>{ state.rangeMin=parseInt(els.rangeMin.value||"0",10); persistSettings(); });
  els.rangeMax.addEventListener("change", ()=>{ state.rangeMax=parseInt(els.rangeMax.value||"0",10); persistSettings(); });
  els.rangeMode.addEventListener("change", ()=>{ state.rangeMode=els.rangeMode.value; persistSettings(); });

  els.resetPrizeToPreset.addEventListener("click", ()=>{
    state.prizeMap = deepClone(PRESETS[state.presetName].prizeMap||{});
    renderPrizeTable(); persistSettings();
  });

  els.batchSize.addEventListener("change", ()=>{ state.batchSize=parseInt(els.batchSize.value||"0",10); persistSettings(); });
  els.speedMs.addEventListener("change", ()=>{ state.speedMs=parseInt(els.speedMs.value||"0",10); persistSettings(); });
  els.stopOnJackpot.addEventListener("change", ()=>{ state.stopOnJackpot=els.stopOnJackpot.checked; persistSettings(); });

  els.filterWins.addEventListener("change", ()=>{ state.winsOnly=els.filterWins.checked; renderLog(); });
  els.searchLog.addEventListener("input", ()=>{ state.searchTerm=els.searchLog.value||""; renderLog(); });
  els.displayLimit.addEventListener("change", ()=>{ state.displayLimit=parseInt(els.displayLimit.value||"300",10); renderLog(); });

  // Theme & Dir
  els.themeToggle.addEventListener("click", ()=>{
    const cur = document.body.getAttribute("data-theme")==="dark" ? "light":"dark";
    document.body.setAttribute("data-theme", cur); persistSettings(); chartDraw();
  });
  els.dirToggle.addEventListener("click", ()=>{
    const d = document.documentElement.getAttribute("dir")==="rtl" ? "ltr":"rtl";
    document.documentElement.setAttribute("dir", d); persistSettings();
  });

  // â€”â€”â€”â€”â€”â€”â€”â€” Init â€”â€”â€”â€”â€”â€”â€”â€”
  loadPresetOptions();
  applyPreset(state.presetName);
  restoreSettings();
  refreshSessionsSelect();
  updateKPI(); updateProgress(); renderLog();
  chartDraw();
})();
</script>
</body>
</html>