<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lottery Simulator â€” Polished Edition</title>
<style>
  /* ====== Design System (cleaned) ====== */
  :root{
    --bg:#0c0e13; --surface:#131826; --surface-2:#1a2032; --text:#ecf2ff; --muted:#9aa4b2;
    --accent:#7dd3fc; --accent-2:#34d399; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
    --border:#20263a; --chip:#1b2234; --stripe:#111728; --shadow:0 10px 24px rgba(0,0,0,.2);
    --radius:12px;
  }
  [data-theme="light"]{
    --bg:#f7f8fc; --surface:#ffffff; --surface-2:#f3f5fb; --text:#0f172a; --muted:#5b6473;
    --accent:#0ea5e9; --accent-2:#22c55e; --danger:#dc2626; --ok:#16a34a; --warn:#d97706;
    --border:#e6e8ef; --chip:#f2f4f8; --stripe:#f9fafb; --shadow:0 8px 18px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font: 14px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Inter", "Vazirmatn", "Helvetica Neue", Arial;
  }
  h1,h2,h3{margin:.25rem 0 .6rem}
  h1{font-size:1.35rem} h2{font-size:1.1rem} h3{font-size:1rem;color:var(--muted)}
  a{color:var(--accent)}
  .container{max-width:1240px;margin:0 auto;padding:16px}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:8px}
  .brand{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .brand h1{display:flex;align-items:center;gap:8px}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:.28rem .6rem;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted);font-weight:600;font-size:12px}
  .row{display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media (max-width:980px){ .row{grid-template-columns:1fr} }
  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .danger{color:var(--danger)}
  .btn{cursor:pointer;border-radius:10px;padding:.58rem .8rem;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.08));color:var(--text);font-weight:700}
  .btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#081018;border:none}
  .btn.secondary{background:linear-gradient(180deg,#a78bfa,#6366f1);color:#0b1020;border:none}
  .btn.warn{background:linear-gradient(180deg,#f87171,#ef4444);color:#fff;border:none}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  input,select{width:100%;padding:.55rem .6rem;border-radius:10px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);outline:none}
  select{appearance:none;background-image:linear-gradient(45deg,transparent 50%, var(--muted) 50%), linear-gradient(135deg, var(--muted) 50%, transparent 50%), linear-gradient(to right, var(--muted), var(--muted));
    background-position:calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px), calc(100% - 2.6em) .45em;background-size:5px 5px, 5px 5px, 1px 1.6em;background-repeat:no-repeat}
  label{display:block;font-weight:700;margin:.15rem 0 .25rem}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .kpi{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  @media(max-width:980px){.kpi{grid-template-columns:repeat(2,1fr)}}
  .kpi .item{padding:12px;background:var(--surface-2);border:1px solid var(--border);border-radius:12px}
  .kpi .title{font-weight:800;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.02em}
  .kpi .value{font-size:1.15rem;font-weight:900;margin-top:2px}
  .sep{height:1px;background:var(--border);margin:10px 0}
  .progress{height:8px;background:var(--chip);border:1px solid var(--border);border-radius:99px;overflow:hidden}
  .progress .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
  .hint{font-size:12px;color:var(--muted)} .small{font-size:12px}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 10px;text-align:center;border-bottom:1px solid var(--border)}
  tbody tr:nth-child(even){background:var(--stripe)}
  tr.win{background:rgba(16,185,129,.09)} tr.jp{background:rgba(99,102,241,.12)}
  canvas{display:block;width:100%;height:240px;background:var(--surface-2);border:1px solid var(--border);border-radius:10px}
  .footer{color:var(--muted);font-size:12px;text-align:center;margin-top:12px}
  /* Toast */
  .toast-wrap{position:fixed;inset-inline-end:16px;inset-block-end:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
  .toast{background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);padding:.55rem .7rem}
</style>
</head>
<body data-theme="dark">
<div class="container">
  <div class="toolbar">
    <div class="brand">
      <h1>ğŸ¯ <span data-i18n="app.title">Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ù„Ø§ØªØ§Ø±ÛŒ â€” Ù†Ø³Ø®Ù‡Ù” Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡</span></h1>
      <div class="chips">
        <span class="chip">Web Worker</span>
        <span class="chip">Crypto RNG</span>
        <span class="chip">Batch UI</span>
        <span class="chip">i18n</span>
        <span class="chip">CSV</span>
      </div>
    </div>
    <div class="chips">
      <button id="themeToggle" class="btn" aria-label="Theme">ğŸŒ“ <span class="small" data-i18n="toolbar.theme">ØªØºÛŒÛŒØ± ØªÙ…</span></button>
      <button id="dirLangToggle" class="btn" aria-label="RTL/LTR">â†”ï¸ <span class="small" data-i18n="toolbar.dirlang">RTL/LTR + Ø²Ø¨Ø§Ù†</span></button>
    </div>
  </div>

  <div class="row">
    <!-- SETTINGS -->
    <section class="card" id="settings">
      <h2 data-i18n="settings.title">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>

      <div class="grid-2">
        <div>
          <label for="preset" data-i18n="labels.preset">Ù¾Ø±ÛŒØ³Øª</label>
          <select id="preset"></select>
        </div>
        <div>
          <label for="ticketPrice" data-i18n="labels.ticketPrice">Ù‚ÛŒÙ…Øª Ø¨Ù„ÛŒØ·</label>
          <input type="number" id="ticketPrice" min="0" step="1"/>
        </div>
        <div>
          <label for="maxNumber" data-i18n="labels.maxNumber">Ø¨Ø§Ø²Ù‡Ù” Ø§ØµÙ„ÛŒ (Û± ØªØ§ N)</label>
          <input type="number" id="maxNumber" min="1" step="1"/>
        </div>
        <div>
          <label for="numbersPerTicket" data-i18n="labels.k">K (ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¯Ø§Ø¯)</label>
          <input type="number" id="numbersPerTicket" min="1" step="1"/>
        </div>
        <div>
          <label for="bonusCount" data-i18n="labels.bonusCount">ØªØ¹Ø¯Ø§Ø¯ Ø¨ÙˆÙ†Ø³</label>
          <input type="number" id="bonusCount" min="0" step="1"/>
        </div>
        <div>
          <label for="bonusPool" data-i18n="labels.bonusPool">Ø§Ø³ØªØ®Ø± Ø¨ÙˆÙ†Ø³ (Û± ØªØ§ M)</label>
          <input type="number" id="bonusPool" min="0" step="1"/>
        </div>
      </div>

      <div class="sep"></div>
      <h3>ğŸ¯ <span data-i18n="target.title">ØªØ§Ø±Ú¯Øª</span></h3>
      <div class="grid-2">
        <div>
          <label for="targetMode" data-i18n="target.mode">Ø­Ø§Ù„Øª ØªØ§Ø±Ú¯Øª</label>
          <select id="targetMode">
            <option value="random" data-i18n="target.random">Ø±Ù†Ø¯ÙˆÙ…</option>
            <option value="manual" data-i18n="target.manual">Ø¯Ø³ØªÛŒ</option>
          </select>
        </div>
        <div style="display:flex;align-items:end;gap:8px">
          <button id="genTarget" class="btn secondary" style="width:100%"><span>ğŸ²</span> <span data-i18n="target.generate">ØªÙˆÙ„ÛŒØ¯ ØªØ§Ø±Ú¯Øª ØªØµØ§Ø¯ÙÛŒ</span></button>
        </div>
      </div>
      <div id="targetMainBox" class="chips"></div>
      <div id="targetBonusBox" class="chips"></div>
      <div class="hint" data-i18n="daily.changeDaily">Ø¯Ø± Ø­Ø§Ù„Øª Ø±ÙˆØ²Ø§Ù†Ù‡ØŒ ØªØ§Ø±Ú¯Øª Ø±ÙˆØ²Ø§Ù†Ù‡ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯</div>

      <div class="sep"></div>
      <h3>ğŸ“† <span data-i18n="daily.title">Ø­Ø§Ù„Øª Ø±ÙˆØ²Ø§Ù†Ù‡</span></h3>
      <div class="grid-3">
        <div><label for="ticketsPerDay" data-i18n="daily.ticketsPerDay">Ø¨Ù„ÛŒØ· Ø¯Ø± Ø±ÙˆØ²</label><input id="ticketsPerDay" type="number" min="1" value="10"></div>
        <div><label for="totalTickets" data-i18n="daily.totalTickets">Ú©Ù„ Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§</label><input id="totalTickets" type="number" min="1" value="100000"></div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:24px">
          <input type="checkbox" id="changeTargetDaily" checked>
          <label for="changeTargetDaily" style="margin:0" data-i18n="daily.changeDaily">ØªØ§Ø±Ú¯Øª Ø±ÙˆØ²Ø§Ù†Ù‡ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯</label>
        </div>
      </div>

      <div class="sep"></div>
      <h3>ğŸ¯ <span data-i18n="range.title">ÙÛŒÙ„ØªØ± Ø¨Ø§Ø²Ù‡Ù” ØªÙˆÙ„ÛŒØ¯</span></h3>
      <div class="grid-3">
        <div><label for="rangeMin" data-i18n="range.from">Ø§Ø²</label><input id="rangeMin" type="number" min="1" value="1"></div>
        <div><label for="rangeMax" data-i18n="range.to">ØªØ§</label><input id="rangeMax" type="number" min="1" value="70"></div>
        <div>
          <label for="rangeMode" data-i18n="range.mode">Ø­Ø§Ù„Øª ÙÛŒÙ„ØªØ±</label>
          <select id="rangeMode">
            <option value="all" data-i18n="range.all">Ù‡Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡</option>
            <option value="any" data-i18n="range.any">Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡</option>
            <option value="off" selected data-i18n="range.off">Ø®Ø§Ù…ÙˆØ´</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>
      <h3>ğŸ’° <span data-i18n="prizes.title">Ø¬ÙˆØ§ÛŒØ²</span></h3>
      <div id="prizeTableWrap" class="table-wrap small"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="resetPrizeToPreset" class="btn"><span>â†©ï¸</span> <span data-i18n="prizes.reset">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ Ù¾Ø±ÛŒØ³Øª</span></button>
      </div>

      <div class="sep"></div>
      <h3>âš¡ï¸ <span data-i18n="perf.title">Ú©Ø§Ø±Ø§ÛŒÛŒ Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ</span></h3>
      <div class="grid-3">
        <div><label for="chunkSize" data-i18n="perf.chunk">Ø§Ù†Ø¯Ø§Ø²Ù‡Ù” Chunk (Worker)</label><input id="chunkSize" type="number" min="50" value="2000"></div>
        <div><label for="speedMs" data-i18n="perf.throttle">ÙˆÙ‚ÙÙ‡Ù” UI (ms)</label><input id="speedMs" type="number" min="0" value="0"></div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:24px">
          <input type="checkbox" id="stopOnJackpot">
          <label for="stopOnJackpot" style="margin:0" data-i18n="perf.stop">ØªÙˆÙ‚Ù Ø¯Ø± Ø¬Ú©â€ŒÙ¾Ø§Øª</label>
        </div>
      </div>

      <div class="grid-3" style="margin-top:6px">
        <div>
          <label for="logMode" data-i18n="log.mode">Ø³Ø·Ø­ Ù„Ø§Ú¯</label>
          <select id="logMode">
            <option value="all" data-i18n="log.all">ØªÙ…Ø§Ù… Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§</option>
            <option value="wins" data-i18n="log.wins">ÙÙ‚Ø· Ø¨Ø±Ø¯Ù‡Ø§</option>
            <option value="none" data-i18n="log.none">Ø¨Ø¯ÙˆÙ† Ù„Ø§Ú¯ (ÙÙ‚Ø· Ø¢Ù…Ø§Ø±)</option>
          </select>
        </div>
        <div>
          <label for="logCap" data-i18n="log.cap">Ø³Ù‚Ù Ø­Ø§ÙØ¸Ù‡Ù” Ù„Ø§Ú¯ (Ø±Ø¯ÛŒÙ)</label>
          <input id="logCap" type="number" min="1000" value="50000">
        </div>
        <div>
          <label for="displayLimit" data-i18n="log.display">Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„</label>
          <select id="displayLimit">
            <option value="300">Û³Û°Û°</option>
            <option value="1000">Û±Û°Û°Û°</option>
            <option value="1000000">Ù‡Ù…Ù‡</option>
          </select>
        </div>
      </div>
    </section>

    <!-- MAIN -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>ğŸ“Š <span data-i18n="stats.title">Ø¢Ù…Ø§Ø± Ø²Ù†Ø¯Ù‡</span></h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="startBtn" class="btn primary">â–¶ï¸ <span data-i18n="btn.start">Ø´Ø±ÙˆØ¹</span></button>
          <button id="pauseBtn" class="btn" disabled>â¸ï¸ <span data-i18n="btn.pause">ØªÙˆÙ‚Ù/Ø§Ø¯Ø§Ù…Ù‡</span></button>
          <button id="resetBtn" class="btn warn" disabled>ğŸ—‘ï¸ <span data-i18n="btn.reset">Ø±ÛŒØ³Øª</span></button>
        </div>
      </div>

      <div class="kpi" id="kpiRow">
        <div class="item"><div class="title" data-i18n="stats.tickets">Tickets</div><div class="value" id="k_tickets">0</div></div>
        <div class="item"><div class="title" data-i18n="stats.days">Days</div><div class="value" id="k_days">0</div></div>
        <div class="item"><div class="title" data-i18n="stats.jackpots">Jackpots</div><div class="value" id="k_jackpots">0</div></div>
        <div class="item"><div class="title" data-i18n="stats.spent">Spent</div><div class="value" id="k_spent">0</div></div>
        <div class="item"><div class="title" data-i18n="stats.paid">Paid</div><div class="value" id="k_paid">0</div></div>
        <div class="item"><div class="title" data-i18n="stats.net">Net P/L</div><div class="value" id="k_net">0</div></div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div class="card" style="padding:10px">
          <h3>ğŸ“ˆ <span data-i18n="chart.title">Ù†Ù…ÙˆØ¯Ø§Ø± Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</span></h3>
          <canvas id="profitChart" width="600" height="260" aria-label="Profit chart"></canvas>
          <div class="small muted" data-i18n="chart.hint">Ù‡Ø± Ù†Ù‚Ø·Ù‡ = Ù¾Ø§ÛŒØ§Ù† ÛŒÚ© Chunk.</div>
        </div>
        <div class="card" style="padding:10px">
          <h3>ğŸ“† <span data-i18n="daily.title">Ø­Ø§Ù„Øª Ø±ÙˆØ²Ø§Ù†Ù‡</span></h3>
          <div class="grid-3">
            <div><div class="title small muted" data-i18n="daily.currentDay">Ø±ÙˆØ² ÙØ¹Ù„ÛŒ</div><div class="value" id="d_day">1</div></div>
            <div><div class="title small muted" data-i18n="daily.today">Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div><div class="value" id="d_today">0</div></div>
            <div><div class="title small muted" data-i18n="daily.winsShort">Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div><div class="value" id="d_wins">0</div></div>
          </div>
          <div class="sep"></div>
          <div class="progress"><div class="bar" id="progressBar"></div></div>
          <div class="small muted" id="progressText"></div>
          <div class="sep"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="exportCsv" class="btn">â¬‡ï¸ <span data-i18n="btn.export">Ø®Ø±ÙˆØ¬ÛŒ CSV</span></button>
            <button id="saveSession" class="btn">ğŸ’¾ <span data-i18n="btn.save">Ø°Ø®ÛŒØ±Ù‡Ù” Ø¬Ù„Ø³Ù‡</span></button>
            <select id="sessionList" style="max-width:240px"></select>
            <button id="loadSession" class="btn">ğŸ“¤ <span data-i18n="btn.load">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ù„Ø³Ù‡</span></button>
            <button id="clearStorage" class="btn">ğŸ§¹ <span data-i18n="btn.clear">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span></button>
          </div>
        </div>
      </div>

      <div class="sep"></div>
      <h3>ğŸ“¦ <span data-i18n="counters.title">Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡Ù” Ø¨Ø±Ø¯Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ·Ø§Ø¨Ù‚</span></h3>
      <div class="card" style="padding:10px">
        <div class="small muted" data-i18n="counters.mainOnly">Â«ÙÙ‚Ø· Ø§ØµÙ„ÛŒ (m)Â»</div>
        <div id="chipsMain" class="chips" style="margin-bottom:8px"></div>
        <div class="small muted" data-i18n="counters.bonusCombos">Â«ØªØ±Ú©ÛŒØ¨â€ŒÙ‡Ø§ÛŒ Ø¨ÙˆÙ†Ø³â€ŒØ¯Ø§Ø± (m+b)Â»</div>
        <div id="chipsBonus" class="chips"></div>
      </div>

      <div class="sep"></div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>ğŸ“œ <span data-i18n="log.title">Ù„Ø§Ú¯</span></h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <label class="small" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="filterWins"> <span data-i18n="log.onlyWins">ÙÙ‚Ø· Ø¨Ø±Ø¯Ù‡Ø§</span></label>
          <input id="searchLog" placeholder="Ø¬Ø³ØªØ¬Ùˆâ€¦" />
        </div>
      </div>
      <div class="table-wrap" id="logTableWrap"></div>
    </section>
  </div>

  <p class="footer">
    Fisherâ€“Yates & Floyd sampling â€¢ Crypto RNG â€¢ Worker-chunked rendering â€¢ LocalStorage â€¢ CSV â€¢ i18n (FA/EN)
  </p>
</div>

<div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script>
(() => {
  // ===========================
  // i18n
  // ===========================
  const I18N = {
    fa: {
      'app.title':'Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ù„Ø§ØªØ§Ø±ÛŒ â€” Ù†Ø³Ø®Ù‡Ù” Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡',
      'toolbar.theme':'ØªØºÛŒÛŒØ± ØªÙ…','toolbar.dirlang':'RTL/LTR + Ø²Ø¨Ø§Ù†',
      'settings.title':'ØªÙ†Ø¸ÛŒÙ…Ø§Øª',
      'labels.preset':'Ù¾Ø±ÛŒØ³Øª','labels.ticketPrice':'Ù‚ÛŒÙ…Øª Ø¨Ù„ÛŒØ·','labels.maxNumber':'Ø¨Ø§Ø²Ù‡Ù” Ø§ØµÙ„ÛŒ (Û± ØªØ§ N)','labels.k':'K (ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¹Ø¯Ø§Ø¯)','labels.bonusCount':'ØªØ¹Ø¯Ø§Ø¯ Ø¨ÙˆÙ†Ø³','labels.bonusPool':'Ø§Ø³ØªØ®Ø± Ø¨ÙˆÙ†Ø³ (Û± ØªØ§ M)',
      'target.title':'ØªØ§Ø±Ú¯Øª','target.mode':'Ø­Ø§Ù„Øª ØªØ§Ø±Ú¯Øª','target.random':'Ø±Ù†Ø¯ÙˆÙ…','target.manual':'Ø¯Ø³ØªÛŒ','target.generate':'ØªÙˆÙ„ÛŒØ¯ ØªØ§Ø±Ú¯Øª ØªØµØ§Ø¯ÙÛŒ',
      'daily.title':'Ø­Ø§Ù„Øª Ø±ÙˆØ²Ø§Ù†Ù‡','daily.ticketsPerDay':'Ø¨Ù„ÛŒØ· Ø¯Ø± Ø±ÙˆØ²','daily.totalTickets':'Ú©Ù„ Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§','daily.changeDaily':'ØªØ§Ø±Ú¯Øª Ø±ÙˆØ²Ø§Ù†Ù‡ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯','daily.currentDay':'Ø±ÙˆØ² ÙØ¹Ù„ÛŒ','daily.today':'Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²','daily.winsShort':'Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²',
      'range.title':'ÙÛŒÙ„ØªØ± Ø¨Ø§Ø²Ù‡Ù” ØªÙˆÙ„ÛŒØ¯','range.from':'Ø§Ø²','range.to':'ØªØ§','range.mode':'Ø­Ø§Ù„Øª ÙÛŒÙ„ØªØ±','range.all':'Ù‡Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡','range.any':'Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡','range.off':'Ø®Ø§Ù…ÙˆØ´',
      'prizes.title':'Ø¬ÙˆØ§ÛŒØ²','prizes.reset':'Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ Ù¾Ø±ÛŒØ³Øª',
      'perf.title':'Ú©Ø§Ø±Ø§ÛŒÛŒ Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ','perf.chunk':'Ø§Ù†Ø¯Ø§Ø²Ù‡Ù” Chunk (Worker)','perf.throttle':'ÙˆÙ‚ÙÙ‡Ù” UI (ms)','perf.stop':'ØªÙˆÙ‚Ù Ø¯Ø± Ø¬Ú©â€ŒÙ¾Ø§Øª',
      'log.title':'Ù„Ø§Ú¯','log.mode':'Ø³Ø·Ø­ Ù„Ø§Ú¯','log.all':'ØªÙ…Ø§Ù… Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§','log.wins':'ÙÙ‚Ø· Ø¨Ø±Ø¯Ù‡Ø§','log.none':'Ø¨Ø¯ÙˆÙ† Ù„Ø§Ú¯ (ÙÙ‚Ø· Ø¢Ù…Ø§Ø±)','log.cap':'Ø³Ù‚Ù Ø­Ø§ÙØ¸Ù‡Ù” Ù„Ø§Ú¯ (Ø±Ø¯ÛŒÙ)','log.display':'Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„','log.onlyWins':'ÙÙ‚Ø· Ø¨Ø±Ø¯Ù‡Ø§','log.searchPh':'Ø¬Ø³ØªØ¬Ùˆ (Ø´Ù…Ø§Ø±Ù‡/Ù¾Ø±ÛŒØ³Øª/Ø±ÙˆØ²)â€¦',
      'btn.start':'Ø´Ø±ÙˆØ¹','btn.pause':'ØªÙˆÙ‚Ù/Ø§Ø¯Ø§Ù…Ù‡','btn.reset':'Ø±ÛŒØ³Øª','btn.export':'Ø®Ø±ÙˆØ¬ÛŒ CSV','btn.save':'Ø°Ø®ÛŒØ±Ù‡Ù” Ø¬Ù„Ø³Ù‡','btn.load':'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ù„Ø³Ù‡','btn.clear':'Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª',
      'stats.title':'Ø¢Ù…Ø§Ø± Ø²Ù†Ø¯Ù‡','stats.tickets':'Tickets','stats.days':'Days','stats.jackpots':'Jackpots','stats.spent':'Spent','stats.paid':'Paid','stats.net':'Net P/L',
      'chart.title':'Ù†Ù…ÙˆØ¯Ø§Ø± Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†','chart.hint':'Ù‡Ø± Ù†Ù‚Ø·Ù‡ = Ù¾Ø§ÛŒØ§Ù† ÛŒÚ© Chunk.',
      'counters.title':'Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡Ù” Ø¨Ø±Ø¯Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ·Ø§Ø¨Ù‚','counters.mainOnly':'ÙÙ‚Ø· Ø§ØµÙ„ÛŒ (m)','counters.bonusCombos':'ØªØ±Ú©ÛŒØ¨â€ŒÙ‡Ø§ÛŒ Ø¨ÙˆÙ†Ø³â€ŒØ¯Ø§Ø± (m+b)',
      'table.timestamp':'timestamp','table.sessionId':'sessionId','table.index':'#','table.day':'Day','table.main':'numbersMain','table.bonus':'numbersBonus','table.matchedMain':'matchedMain','table.matchedBonus':'matchedBonus','table.prize':'prize','table.spent':'spent','table.net':'net','table.preset':'preset',
      'toast.saved':'Ø¬Ù„Ø³Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.','toast.loaded':'Ø¬Ù„Ø³Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.','toast.cleared':'Ù¾Ø§Ú© Ø´Ø¯.','toast.noLog':'Ù„Ø§Ú¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ù†ÛŒØ³Øª.','toast.invalidRange':'Ø¹Ø±Ø¶ Ø¨Ø§Ø²Ù‡ Ø¨Ø§ÛŒØ¯ â‰¥ K Ø¨Ø§Ø´Ø¯.','toast.invalidTarget':'ØªØ§Ø±Ú¯Øª Ø¯Ø³ØªÛŒ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª (ØªÚ©Ø±Ø§Ø±ÛŒ/Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¨Ø§Ø²Ù‡).'
    },
    en: {
      'app.title':'Lottery Simulator â€” Polished Edition',
      'toolbar.theme':'Theme','toolbar.dirlang':'RTL/LTR + Lang',
      'settings.title':'Settings',
      'labels.preset':'Preset','labels.ticketPrice':'Ticket price','labels.maxNumber':'Main pool (1..N)','labels.k':'K (numbers per ticket)','labels.bonusCount':'Bonus count','labels.bonusPool':'Bonus pool (1..M)',
      'target.title':'Target (Draw)','target.mode':'Target mode','target.random':'Random','target.manual':'Manual','target.generate':'Generate random target',
      'daily.title':'Daily draw mode','daily.ticketsPerDay':'Tickets per day','daily.totalTickets':'Total tickets','daily.changeDaily':'Change target daily','daily.currentDay':'Current day','daily.today':'Today tickets','daily.winsShort':'Today wins',
      'range.title':'Range filter for generation','range.from':'From','range.to':'To','range.mode':'Filter mode','range.all':'All inside range','range.any':'At least one in range','range.off':'Off',
      'prizes.title':'Prizes','prizes.reset':'Reset to preset',
      'perf.title':'Performance & Stability','perf.chunk':'Chunk size (Worker)','perf.throttle':'UI throttle (ms)','perf.stop':'Stop on jackpot',
      'log.title':'Log','log.mode':'Log level','log.all':'All tickets','log.wins':'Only wins','log.none':'No log (stats only)','log.cap':'Log memory cap (rows)','log.display':'Table display','log.onlyWins':'Wins only','log.searchPh':'Search (number/preset/day)â€¦',
      'btn.start':'Start','btn.pause':'Pause/Resume','btn.reset':'Reset','btn.export':'Export CSV','btn.save':'Save session','btn.load':'Load session','btn.clear':'Clear settings',
      'stats.title':'Live stats','stats.tickets':'Tickets','stats.days':'Days','stats.jackpots':'Jackpots','stats.spent':'Spent','stats.paid':'Paid','stats.net':'Net P/L',
      'chart.title':'Profit/Loss chart','chart.hint':'Each point = end of a chunk.',
      'counters.title':'Win counters by match','counters.mainOnly':'Main only (m)','counters.bonusCombos':'Bonus combos (m+b)',
      'table.timestamp':'timestamp','table.sessionId':'sessionId','table.index':'#','table.day':'Day','table.main':'numbersMain','table.bonus':'numbersBonus','table.matchedMain':'matchedMain','table.matchedBonus':'matchedBonus','table.prize':'prize','table.spent':'spent','table.net':'net','table.preset':'preset',
      'toast.saved':'Session saved.','toast.loaded':'Session loaded.','toast.cleared':'Cleared.','toast.noLog':'No log to export.','toast.invalidRange':'Range width must be â‰¥ K.','toast.invalidTarget':'Manual target is invalid (duplicates/out of bounds).'
    }
  };

  // Preset display names per language
  const PRESET_LABELS = {
    "Mega Millions": {fa:"Mega Millions", en:"Mega Millions"},
    "Powerball": {fa:"Powerball", en:"Powerball"},
    "EuroMillions": {fa:"EuroMillions", en:"EuroMillions"},
    "Cash Five (TX)": {fa:"Cash Five (TX)", en:"Cash Five (TX)"},
    "Mini Lotto": {fa:"Mini Lotto", en:"Mini Lotto"},
    "Lotto 6/49": {fa:"Lotto 6/49", en:"Lotto 6/49"},
    "Custom": {fa:"Ø³ÙØ§Ø±Ø´ÛŒ (Custom)", en:"Custom"}
  };

  // ===========================
  // Data & Presets
  // ===========================
  const PRESETS = {
    "Mega Millions": { name:"Mega Millions", n:70, k:5, bonusCount:1, bonusPool:25, ticketPrice:2000,
      prizeMap:{ "2":500,"3":10000,"4":50000,"5":1000000,"2+1":2000,"3+1":50000,"4+1":200000,"5+1":50000000 } },
    "Powerball": { name:"Powerball", n:69, k:5, bonusCount:1, bonusPool:26, ticketPrice:2000,
      prizeMap:{ "2":500,"3":10000,"4":50000,"5":1000000,"2+1":2000,"3+1":50000,"4+1":200000,"5+1":50000000 } },
    "EuroMillions": { name:"EuroMillions", n:50, k:5, bonusCount:2, bonusPool:12, ticketPrice:2500,
      prizeMap:{ "2":2000,"3":10000,"4":50000,"5":1000000,"2+1":5000,"3+1":20000,"4+1":100000,"5+1":5000000,"5+2":50000000 } },
    "Cash Five (TX)": { name:"Cash Five (TX)", n:35, k:5, bonusCount:0, bonusPool:0, ticketPrice:1000,
      prizeMap:{ "2":2000,"3":10000,"4":50000,"5":1000000 } },
    "Mini Lotto": { name:"Mini Lotto", n:42, k:5, bonusCount:0, bonusPool:0, ticketPrice:1000,
      prizeMap:{ "2":2000,"3":10000,"4":50000,"5":1000000 } },
    "Lotto 6/49": { name:"Lotto 6/49", n:49, k:6, bonusCount:0, bonusPool:0, ticketPrice:2000,
      prizeMap:{ "2":2000,"3":10000,"4":50000,"5":200000,"6":1000000 } },
    "Custom": { name:"Custom", n:49, k:6, bonusCount:0, bonusPool:0, ticketPrice:1000, prizeMap:{} }
  };

  // ===========================
  // State
  // ===========================
  let worker = null;
  const els = {
    preset: $("#preset"), ticketPrice: $("#ticketPrice"), maxNumber: $("#maxNumber"), numbersPerTicket: $("#numbersPerTicket"),
    bonusCount: $("#bonusCount"), bonusPool: $("#bonusPool"),
    targetMode: $("#targetMode"), genTarget: $("#genTarget"),
    targetMainBox: $("#targetMainBox"), targetBonusBox: $("#targetBonusBox"),
    ticketsPerDay: $("#ticketsPerDay"), totalTickets: $("#totalTickets"), changeTargetDaily: $("#changeTargetDaily"),
    rangeMin: $("#rangeMin"), rangeMax: $("#rangeMax"), rangeMode: $("#rangeMode"),
    prizeTableWrap: $("#prizeTableWrap"), resetPrizeToPreset: $("#resetPrizeToPreset"),
    chunkSize: $("#chunkSize"), speedMs: $("#speedMs"), stopOnJackpot: $("#stopOnJackpot"),
    logMode: $("#logMode"), logCap: $("#logCap"), displayLimit: $("#displayLimit"),
    startBtn: $("#startBtn"), pauseBtn: $("#pauseBtn"), resetBtn: $("#resetBtn"),
    k_tickets: $("#k_tickets"), k_days: $("#k_days"), k_jackpots: $("#k_jackpots"),
    k_spent: $("#k_spent"), k_paid: $("#k_paid"), k_net: $("#k_net"),
    d_day: $("#d_day"), d_today: $("#d_today"), d_wins: $("#d_wins"),
    progressBar: $("#progressBar"), progressText: $("#progressText"),
    exportCsv: $("#exportCsv"), saveSession: $("#saveSession"), sessionList: $("#sessionList"),
    loadSession: $("#loadSession"), clearStorage: $("#clearStorage"),
    logTableWrap: $("#logTableWrap"), filterWins: $("#filterWins"), searchLog: $("#searchLog"),
    themeToggle: $("#themeToggle"), dirLangToggle: $("#dirLangToggle"),
    profitChart: $("#profitChart"), toastWrap: $("#toastWrap"),
    chipsMain: $("#chipsMain"), chipsBonus: $("#chipsBonus")
  };

  let state = {
    // locale & layout
    lang: 'fa', locale: 'fa-IR',
    // core
    presetName:"Mega Millions",
    n:70,k:5,bonusCount:1,bonusPool:25,ticketPrice:2000, prizeMap:{},
    targetMode:"random", targetMain:[], targetBonus:[],
    ticketsPerDay:10,totalTickets:100000,changeTargetDaily:true,
    rangeMode:"off", rangeMin:1, rangeMax:70,
    chunkSize:2000,speedMs:0,stopOnJackpot:false,
    logMode:"all", logCap:50000, displayLimit:300,
    // runtime
    sessionId:null, isRunning:false, isPaused:false,
    day:1,todayTickets:0,todayWins:0,
    stats:{tickets:0,days:0,jackpots:0,spent:0,paid:0,net:0,matchCounts:{}},
    rows:[], winsOnlyFilter:false, searchTerm:""
  };

  const fmt = (x)=> new Intl.NumberFormat(state.locale).format(x|0);
  const nowIso = ()=> new Date().toISOString();

  // ===========================
  // Helpers
  // ===========================
  function $(s){ return document.querySelector(s); }
  function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
  function create(tag, attrs={}, html=""){ const el=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>el.setAttribute(k,v)); if(html) el.innerHTML=html; return el; }

  function toast(msgKey){
    const div = create("div", {class:"toast"}, `<span>${t(msgKey)}</span>`);
    els.toastWrap.appendChild(div);
    setTimeout(()=>{ div.style.opacity='.92'; }, 20);
    setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateY(6px)'; }, 2500);
    setTimeout(()=>{ div.remove(); }, 3000);
  }

  // i18n utilities
  function t(key){ const dict=I18N[state.lang]||I18N.fa; return dict[key] || key; }
  function applyI18n(){
    // text nodes
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const k = el.getAttribute("data-i18n");
      el.textContent = t(k);
    });
    // placeholders
    els.searchLog.setAttribute("placeholder", t('log.searchPh'));
    // preset select labels
    loadPresetOptions(); // re-render visible labels
    // document lang/dir
    document.documentElement.lang = (state.lang==='fa'?'fa':'en');
    document.documentElement.dir = (state.lang==='fa'?'rtl':'ltr');
  }

  // Theme + Dir/Lang
  els.themeToggle.addEventListener("click", ()=>{
    const cur = document.body.getAttribute("data-theme")==="dark" ? "light":"dark";
    document.body.setAttribute("data-theme", cur); persistSettings(); chartDraw();
  });
  els.dirLangToggle.addEventListener("click", ()=>{
    // Toggle both direction and language per your request
    if(state.lang==='fa'){ state.lang='en'; state.locale='en-US'; }
    else { state.lang='fa'; state.locale='fa-IR'; }
    applyI18n(); persistSettings(); chartDraw(); renderLog(); updateKPI();
  });

  // ===========================
  // Prize table & match chips
  // ===========================
  function buildPrizeKeys(k, bCount){
    const keys=[]; for(let m=2;m<=k;m++){ keys.push(String(m)); for(let b=1;b<=bCount;b++) keys.push(`${m}+${b}`); }
    return keys;
  }
  function isJackKey(key){
    const [m,b=0]=key.split("+").map(x=>+x||0);
    if(state.bonusCount>0) return (m===state.k && b===state.bonusCount);
    return m===state.k;
  }
  function renderPrizeTable(){
    const keys=buildPrizeKeys(state.k,state.bonusCount);
    for(const k of keys) if(!(k in state.prizeMap)) state.prizeMap[k]=0;
    const sorted=keys.slice().sort((a,b)=>{
      const [am,ab=0]=a.split("+").map(x=>+x||0), [bm,bb=0]=b.split("+").map(x=>+x||0);
      if(am!==bm) return bm-am; return bb-ab;
    });
    const thead = `<table><thead><tr><th>Match</th><th>${t('prizes.title')}</th></tr></thead><tbody>`;
    const rows = sorted.map(key=>{
      const jack = isJackKey(key) ? ' <span class="chip">Jackpot</span>' : '';
      return `<tr><td><strong>${key}</strong>${jack}</td>
        <td><input class="prize-input" data-key="${key}" type="number" min="0" step="1" value="${state.prizeMap[key]|0}"></td></tr>`;
    }).join("");
    els.prizeTableWrap.innerHTML = thead + rows + `</tbody></table>`;
    els.prizeTableWrap.querySelectorAll(".prize-input").forEach(inp=>{
      inp.addEventListener("change", e=>{
        const k=e.target.dataset.key; state.prizeMap[k]=parseInt(e.target.value||"0",10); persistSettings();
      });
    });
    renderMatchChipsSkeleton();
  }
  function renderMatchChipsSkeleton(){
    els.chipsMain.innerHTML=""; els.chipsBonus.innerHTML="";
    for(let m=2;m<=state.k;m++){
      const span=create("span",{class:"chip", "data-key":`m-${m}`}, `<b>${m}</b> â†’ <span class="muted">0</span>`);
      els.chipsMain.appendChild(span);
    }
    for(let b=1;b<=state.bonusCount;b++){
      for(let m=2;m<=state.k;m++){
        const span=create("span",{class:"chip","data-key":`mb-${m}+${b}`}, `<b>${m}+${b}</b> â†’ <span class="muted">0</span>`);
        els.chipsBonus.appendChild(span);
      }
    }
  }
  function updateMatchChips(matchCounts){
    for(let m=2;m<=state.k;m++){
      let sum = (matchCounts[String(m)]|0);
      for(let b=1;b<=state.bonusCount;b++) sum += (matchCounts[`${m}+${b}`]|0);
      const el = els.chipsMain.querySelector(`[data-key="m-${m}"] span`); if(el) el.textContent = fmt(sum);
    }
    for(let b=1;b<=state.bonusCount;b++){
      for(let m=2;m<=state.k;m++){
        const el = els.chipsBonus.querySelector(`[data-key="mb-${m}+${b}"] span`); if(el) el.textContent = fmt(state.stats.matchCounts[`${m}+${b}`]|0);
      }
    }
  }

  // ===========================
  // Target inputs & validation
  // ===========================
  function renderTargetInputs(){
    const mk=(parent,count,label)=>{
      parent.innerHTML="";
      const title=create("div",{class:"muted"},label); parent.appendChild(title);
      for(let i=0;i<count;i++){
        const inp=create("input",{type:"number",min:"1",step:"1"}); inp.style.width="64px"; inp.style.textAlign="center";
        inp.addEventListener("change", ()=>{
          if(parent===els.targetMainBox) state.targetMain[i]=parseInt(inp.value||"0",10);
          else state.targetBonus[i]=parseInt(inp.value||"0",10);
          persistSettings();
        });
        parent.appendChild(inp);
      }
    };
    mk(els.targetMainBox, state.k, state.lang==='fa'?'Ø§Ø¹Ø¯Ø§Ø¯ Ø§ØµÙ„ÛŒ (K)':'Main numbers (K)');
    if(state.bonusCount>0) mk(els.targetBonusBox, state.bonusCount, state.lang==='fa'?'Ø¨ÙˆÙ†Ø³':'Bonus');
    syncTargetInputs();
  }
  function syncTargetInputs(){
    Array.from(els.targetMainBox.querySelectorAll("input")).forEach((inp,i)=> inp.value = state.targetMain[i]||"");
    Array.from(els.targetBonusBox.querySelectorAll("input")).forEach((inp,i)=> inp.value = state.targetBonus[i]||"");
  }
  function randomizeTarget(){
    state.targetMain = sampleUniqueUI(state.n,state.k);
    state.targetBonus = state.bonusCount>0 ? sampleUniqueUI(state.bonusPool,state.bonusCount):[];
    syncTargetInputs();
  }
  function validateManualTarget(){
    if(state.targetMode!=="manual") return true;
    const uniq = (arr)=>new Set(arr.filter(Boolean)).size === arr.filter(Boolean).length;
    const inRange = (arr,max)=>arr.every(v=>v>=1 && v<=max);
    const tm = state.targetMain||[], tb = state.targetBonus||[];
    if(tm.length!==state.k || !uniq(tm) || !inRange(tm, state.n)) return false;
    if(state.bonusCount>0 && (tb.length!==state.bonusCount || !uniq(tb) || !inRange(tb, state.bonusPool))) return false;
    return true;
  }
  function sampleUniqueUI(n,k){
    const a=Array.from({length:n},(_,i)=>i+1);
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a.slice(0,k).sort((x,y)=>x-y);
  }

  // ===========================
  // LocalStorage
  // ===========================
  const LS_SETTINGS="lotto.settings.v3", LS_SESSIONS="lotto.sessions.v1";
  function persistSettings(){
    const toSave = {
      lang:state.lang, locale:state.locale,
      presetName: state.presetName, n: state.n, k: state.k, bonusCount: state.bonusCount, bonusPool: state.bonusPool, ticketPrice: state.ticketPrice,
      prizeMap: state.prizeMap, targetMode: state.targetMode, targetMain: state.targetMain, targetBonus: state.targetBonus,
      ticketsPerDay: state.ticketsPerDay, totalTickets: state.totalTickets, changeTargetDaily: state.changeTargetDaily,
      rangeMode: state.rangeMode, rangeMin: state.rangeMin, rangeMax: state.rangeMax,
      chunkSize: state.chunkSize, speedMs: state.speedMs, stopOnJackpot: state.stopOnJackpot,
      logMode: state.logMode, logCap: state.logCap, displayLimit: state.displayLimit,
      theme:document.body.getAttribute("data-theme")
    };
    localStorage.setItem(LS_SETTINGS, JSON.stringify(toSave));
  }
  function restoreSettings(){
    const raw=localStorage.getItem(LS_SETTINGS); if(!raw) return;
    try{
      const s=JSON.parse(raw);
      Object.assign(state, s);
      // reflect UI
      els.preset.value=state.presetName; els.maxNumber.value=state.n; els.numbersPerTicket.value=state.k;
      els.bonusCount.value=state.bonusCount; els.bonusPool.value=state.bonusPool; els.ticketPrice.value=state.ticketPrice;
      els.targetMode.value=state.targetMode; els.ticketsPerDay.value=state.ticketsPerDay; els.totalTickets.value=state.totalTickets; els.changeTargetDaily.checked=state.changeTargetDaily;
      els.rangeMode.value=state.rangeMode; els.rangeMin.value=state.rangeMin; els.rangeMax.value=state.rangeMax;
      els.chunkSize.value=state.chunkSize; els.speedMs.value=state.speedMs; els.stopOnJackpot.checked=state.stopOnJackpot;
      els.logMode.value=state.logMode; els.logCap.value=state.logCap; els.displayLimit.value=state.displayLimit;
      if(s.theme) document.body.setAttribute("data-theme", s.theme);
    }catch(e){}
  }

  function refreshSessionsSelect(){
    const raw=localStorage.getItem(LS_SESSIONS); let obj={}; try{obj=JSON.parse(raw||"{}")}catch(e){}
    els.sessionList.innerHTML = `<option value="">â€”</option>` +
      Object.keys(obj).sort().reverse().map(id=>{
        const ss=obj[id]; return `<option value="${id}">${id} â€” ${ss.presetName} â€” t:${ss.stats?.tickets||0}</option>`;
      }).join("");
  }

  // ===========================
  // Chart (Canvas)
  // ===========================
  const chart = { ctx: els.profitChart.getContext("2d"), points:[], maxPoints:2000 };
  function chartReset(){ chart.points.length=0; chartDraw(); }
  function chartAddPoint(tickets, net){ chart.points.push({x:+tickets,y:+net}); if(chart.points.length>chart.maxPoints) chart.points.shift(); chartDraw(); }
  function chartDraw(){
    const c=els.profitChart, ctx=chart.ctx; ctx.clearRect(0,0,c.width,c.height);
    const pad={l:48,r:10,t:10,b:24}, w=c.width-pad.l-pad.r, h=c.height-pad.t-pad.b;
    const xs=chart.points.map(p=>p.x), ys=chart.points.map(p=>p.y);
    const minX=xs.length?Math.min(...xs):0, maxX=xs.length?Math.max(...xs):1;
    const minY=ys.length?Math.min(...ys):-100, maxY=ys.length?Math.max(...ys):100;
    const cs=getComputedStyle(document.body);
    ctx.strokeStyle=cs.getPropertyValue('--border'); ctx.lineWidth=1; ctx.beginPath();
    for(let i=0;i<=5;i++){ const y=pad.t+h*(i/5); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+w,y); }
    ctx.stroke();
    ctx.fillStyle=cs.getPropertyValue('--muted'); ctx.font="12px ui-sans-serif"; ctx.textAlign="right"; ctx.textBaseline="middle";
    ctx.fillText(fmt(maxY), pad.l-6, pad.t); ctx.fillText(fmt(minY), pad.l-6, pad.t+h);
    if(chart.points.length>1){
      ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle=cs.getPropertyValue('--accent-2');
      chart.points.forEach((p,i)=>{ const x=pad.l+w*((p.x-minX)/(maxX-minX||1)), y=pad.t+h*(1-(p.y-minY)/(maxY-minY||1)); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.stroke();
    }
  }

  // ===========================
  // Log Table (windowed rendering by limit)
  // ===========================
  function renderLog(){
    const rows = state.rows;
    let filtered = state.winsOnlyFilter ? rows.filter(r=>r.prizeAmount>0) : rows;
    const q=(state.searchTerm||"").trim().toLowerCase();
    if(q) filtered = filtered.filter(r =>
      r.presetName.toLowerCase().includes(q) || r.timestamp.includes(q) || String(r.ticketIndex).includes(q) ||
      String(r.day).includes(q) || r.numbersMain.join(",").includes(q) || (r.numbersBonus||[]).join(",").includes(q) || String(r.prizeAmount).includes(q)
    );
    const N = state.displayLimit|0; const view = filtered.slice(-N);
    const head=`<table><thead><tr>
      <th>${t('table.timestamp')}</th><th>${t('table.sessionId')}</th><th>${t('table.index')}</th><th>${t('table.day')}</th>
      <th>${t('table.main')}</th><th>${t('table.bonus')}</th><th>${t('table.matchedMain')}</th><th>${t('table.matchedBonus')}</th>
      <th>${t('table.prize')}</th><th>${t('table.spent')}</th><th>${t('table.net')}</th><th>${t('table.preset')}</th>
    </tr></thead><tbody>`;
    const body=view.map(r=>{
      const cls=r.prizeAmount>0 ? ((r.matchedMain===state.k && r.matchedBonus===state.bonusCount)? "jp":"win") : "";
      return `<tr class="${cls}">
        <td>${r.timestamp}</td><td class="small">${r.sessionId}</td><td>${r.ticketIndex}</td><td>${r.day}</td>
        <td>${r.numbersMain.join(",")}</td><td>${(r.numbersBonus||[]).join(",")}</td>
        <td>${r.matchedMain}</td><td>${r.matchedBonus}</td>
        <td>${fmt(r.prizeAmount)}</td><td>${fmt(r.spentAmount)}</td><td>${fmt(r.netAmount)}</td><td>${r.presetName}</td></tr>`;
    }).join("");
    els.logTableWrap.innerHTML = head+body+`</tbody></table>`;
  }

  // ===========================
  // KPI & progress
  // ===========================
  function updateKPI(){
    els.k_tickets.textContent=fmt(state.stats.tickets);
    els.k_days.textContent=fmt(state.stats.days);
    els.k_jackpots.textContent=fmt(state.stats.jackpots);
    els.k_spent.textContent=fmt(state.stats.spent);
    els.k_paid.textContent=fmt(state.stats.paid);
    const net = state.stats.paid - state.stats.spent;
    els.k_net.textContent=fmt(net);
    els.k_net.style.color = net>=0 ? getComputedStyle(document.body).getPropertyValue('--ok') : getComputedStyle(document.body).getPropertyValue('--danger');

    els.d_day.textContent = state.day;
    els.d_today.textContent = state.todayTickets;
    els.d_wins.textContent = state.todayWins;

    const pct = Math.floor((state.stats.tickets/(state.totalTickets||1))*100);
    els.progressBar.style.width = Math.max(0,Math.min(100,pct))+"%";
    els.progressText.textContent = (state.lang==='fa'
      ? `Ù¾ÛŒØ´Ø±ÙØª: ${fmt(state.stats.tickets)}/${fmt(state.totalTickets)} (${pct}%)`
      : `Progress: ${fmt(state.stats.tickets)}/${fmt(state.totalTickets)} (${pct}%)`);

    updateMatchChips(state.stats.matchCounts||{});
  }

  // ===========================
  // CSV
  // ===========================
  function toCSV(){
    const header = "timestamp,sessionId,ticketIndex,day,numbersMain,numbersBonus,matchedMain,matchedBonus,prizeAmount,spentAmount,netAmount,presetName";
    const lines = state.rows.map(r=>{
      return [
        r.timestamp, r.sessionId, r.ticketIndex, r.day,
        `"${r.numbersMain.join(",")}"`, `"${(r.numbersBonus||[]).join(",")}"`,
        r.matchedMain, r.matchedBonus, r.prizeAmount, r.spentAmount, r.netAmount, `"${r.presetName}"`
      ].join(",");
    });
    return [header, ...lines].join("\n");
  }
  function download(filename,text){
    const blob=new Blob([text],{type:"text/csv;charset=utf-8;"}); const a=document.createElement("a");
    const url=URL.createObjectURL(blob); a.href=url; a.download=filename; a.style.display="none"; document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  // ===========================
  // Worker
  // ===========================
  function createWorker(){
    const code = `
    let running=false, paused=false, cfg=null;
    function randBelow(n){ const max=0x100000000; const limit=Math.floor(max/n)*n; const buf=new Uint32Array(1); let r; do{crypto.getRandomValues(buf); r=buf[0];}while(r>=limit); return r % n; }
    function randBetween1(n){ return randBelow(n)+1; }
    function sampleUnique(n,k){ const map=new Map(); const res=new Array(k); for(let i=0;i<k;i++){ const r=randBetween1(n-i); const x=map.get(r)||r; const y=map.get(n-i)||(n-i); map.set(r,y); res[i]=x; } res.sort((a,b)=>a-b); return res; }
    function countMatches(arr,set){ let c=0; for(let i=0;i<arr.length;i++) if(set.has(arr[i])) c++; return c; }
    function calcPrize(pm,m,b){ const k2=b>0? (m+"+"+b):null; if(k2!=null && pm.hasOwnProperty(k2)) return pm[k2]|0; if(pm.hasOwnProperty(String(m))) return pm[String(m)]|0; return 0; }
    function inRange(main,mode,a,b){ if(mode==="off")return true; if(a>b)return true; if(mode==="all")return main.every(x=>x>=a&&x<=b); if(mode==="any")return main.some(x=>x>=a&&x<=b); return true; }
    function viableAllRange(k,a,b){ return (b-a+1) >= k; }
    function randomizeTarget(n,k,bc,bp){ const main=sampleUnique(n,k); const bonus=bc>0? sampleUnique(bp,bc):[]; return {main,bonus}; }
    function nowIso(){ return new Date().toISOString(); }
    function rowObj(sessionId, idx, day, t, m, b, prize, spent, net, presetName){
      return {timestamp:nowIso(), sessionId, ticketIndex:idx, day, numbersMain:t.main, numbersBonus:t.bonus, matchedMain:m, matchedBonus:b, prizeAmount:prize|0, spentAmount:spent|0, netAmount:net|0, presetName};
    }
    const sleep=(ms)=> new Promise(r=>setTimeout(r,ms));

    self.onmessage = async (e)=>{
      const {type, config} = e.data||{};
      if(type==="start"){
        cfg=config;
        if(cfg.rangeMode==="all" && !viableAllRange(cfg.k, cfg.rangeMin|0, cfg.rangeMax|0)){ self.postMessage({type:"error", message:"INVALID_RANGE"}); return; }
        running=true; paused=false; await run();
      } else if(type==="pause"){ paused=true; }
      else if(type==="resume"){ paused=false; }
      else if(type==="stop"){ running=false; }
    };

    async function run(){
      const stats={tickets:0,days:1,jackpots:0,spent:0,paid:0,net:0,matchCounts:{}};
      let day=1, todayTickets=0, todayWins=0;
      let targetMain=(cfg.targetMode==="manual"&&(cfg.targetMain||[]).length===cfg.k)? cfg.targetMain.slice().sort((a,b)=>a-b):null;
      let targetBonus=(cfg.targetMode==="manual"&&(cfg.targetBonus||[]).length===cfg.bonusCount)? cfg.targetBonus.slice().sort((a,b)=>a-b):[];
      if(cfg.targetMode==="random" || !targetMain){ const t=randomizeTarget(cfg.n,cfg.k,cfg.bonusCount,cfg.bonusPool); targetMain=t.main; targetBonus=t.bonus; }
      let targetSet=new Set(targetMain), bonusSet=new Set(targetBonus);

      const total=cfg.totalTickets|0, chunk=Math.max(1,cfg.chunkSize|0), spentPer=cfg.ticketPrice|0;

      for(let done=0; done<total && running; ){
        if(paused){ await sleep(60); continue; }
        const limit=Math.min(chunk,total-done);
        const rows=(cfg.logMode==="none")? null: [];
        for(let i=0;i<limit && running;i++){
          if(todayTickets >= (cfg.ticketsPerDay|0)){
            stats.days++; day++; todayTickets=0; todayWins=0;
            if(cfg.changeTargetDaily && cfg.targetMode==="random"){ const t=randomizeTarget(cfg.n,cfg.k,cfg.bonusCount,cfg.bonusPool); targetMain=t.main; targetBonus=t.bonus; targetSet=new Set(targetMain); bonusSet=new Set(targetBonus); }
          }
          // ticket with range
          let t=null, tries=0;
          while(true){
            tries++; const main=sampleUnique(cfg.n,cfg.k);
            if(inRange(main,cfg.rangeMode, cfg.rangeMin|0, cfg.rangeMax|0)){ const bonus=cfg.bonusCount>0? sampleUnique(cfg.bonusPool,cfg.bonusCount):[]; t={main,bonus}; break; }
            if(tries>2000){ const bonus=cfg.bonusCount>0? sampleUnique(cfg.bonusPool,cfg.bonusCount):[]; t={main:sampleUnique(cfg.n,cfg.k), bonus}; break; }
          }
          const m=countMatches(t.main, targetSet); const b=cfg.bonusCount>0? countMatches(t.bonus, bonusSet):0;
          const prize=calcPrize(cfg.prizeMap,m,b); const spent=spentPer; const net=(prize|0)-(spent|0);
          stats.tickets++; todayTickets++; stats.spent+=spent; stats.paid+=prize; stats.net=stats.paid-stats.spent;
          const key=b>0? (m+"+"+b): String(m); stats.matchCounts[key]=(stats.matchCounts[key]|0)+1;
          const isJack=(cfg.bonusCount>0)? (m===cfg.k && b===cfg.bonusCount): (m===cfg.k);
          if(isJack){ stats.jackpots++; todayWins++; if(cfg.stopOnJackpot){ rows && rows.push(rowObj(cfg.sessionId, stats.tickets, day, t, m, b, prize, spent, net, cfg.presetName)); running=false; break; } }
          if(prize>0) todayWins++;
          if(rows && (cfg.logMode==="all" || (cfg.logMode==="wins" && prize>0))) rows.push(rowObj(cfg.sessionId, stats.tickets, day, t, m, b, prize, spent, net, cfg.presetName));
          done++;
        }
        self.postMessage({type:"chunk", stats, rows, day, todayTickets, todayWins});
        if(!running) break;
        if((cfg.delayMs|0)>0) await sleep(cfg.delayMs|0);
      }
      self.postMessage({type:"done"});
    }
    `;
    const blob = new Blob([code], {type:"application/javascript"});
    const url = URL.createObjectURL(blob);
    const w = new Worker(url); w._url=url; return w;
  }
  function destroyWorker(){ if(worker){ worker.terminate(); URL.revokeObjectURL(worker._url); worker=null; } }
  window.addEventListener("beforeunload", destroyWorker);

  // ===========================
  // Run / Pause / Reset
  // ===========================
  function start(){
    if(state.isRunning) return;
    if(state.rangeMode==="all" && (state.rangeMax - state.rangeMin + 1) < state.k){ toast('toast.invalidRange'); return; }
    if(!validateManualTarget()){ toast('toast.invalidTarget'); return; }

    state.isRunning=true; state.isPaused=false; state.sessionId=`session-${nowIso().replace(/[-:TZ.]/g,"").slice(0,14)}`;
    state.rows.length=0;
    state.stats={tickets:0,days:1,jackpots:0,spent:0,paid:0,net:0,matchCounts:{}};
    state.day=1; state.todayTickets=0; state.todayWins=0;
    chartReset(); updateKPI(); renderLog();

    destroyWorker(); worker = createWorker();
    worker.onmessage = (e)=>{
      const {type} = e.data||{};
      if(type==="error"){ if(e.data.message==="INVALID_RANGE") toast('toast.invalidRange'); stop(true); return; }
      if(type==="chunk"){
        const {stats, rows, day, todayTickets, todayWins} = e.data;
        state.stats=stats; state.day=day; state.todayTickets=todayTickets; state.todayWins=todayWins;
        if(rows && rows.length){
          state.rows.push(...rows);
          const cap = state.logCap|0;
          if(state.rows.length > cap){ state.rows.splice(0, state.rows.length - cap); }
        }
        updateKPI(); renderLog(); chartAddPoint(state.stats.tickets, state.stats.net);
      }
      if(type==="done"){ stop(false); }
    };
    const config = {
      sessionId: state.sessionId, presetName: state.presetName,
      n: state.n, k: state.k, bonusCount: state.bonusCount, bonusPool: state.bonusPool, ticketPrice: state.ticketPrice, prizeMap: state.prizeMap,
      targetMode: state.targetMode, targetMain: state.targetMain, targetBonus: state.targetBonus,
      ticketsPerDay: state.ticketsPerDay, totalTickets: state.totalTickets, changeTargetDaily: state.changeTargetDaily,
      rangeMode: state.rangeMode, rangeMin: state.rangeMin, rangeMax: state.rangeMax,
      chunkSize: state.chunkSize, delayMs: state.speedMs, stopOnJackpot: state.stopOnJackpot, logMode: state.logMode
    };
    worker.postMessage({type:"start", config});
    els.startBtn.disabled=true; els.pauseBtn.disabled=false; els.resetBtn.disabled=false;
  }
  function pause(){
    if(!state.isRunning) return;
    state.isPaused = !state.isPaused;
    if(state.isPaused){ worker?.postMessage({type:"pause"}); }
    else { worker?.postMessage({type:"resume"}); }
    // text is i18n static; we won't switch label here
  }
  function stop(aborted){
    state.isRunning=false; state.isPaused=false;
    els.startBtn.disabled=false; els.pauseBtn.disabled=true; els.resetBtn.disabled=true;
    destroyWorker(); updateKPI(); renderLog();
    if(aborted) return;
  }

  // ===========================
  // UI bindings
  // ===========================
  function loadPresetOptions(){
    els.preset.innerHTML = Object.keys(PRESETS).map(n=>`<option value="${n}">${PRESET_LABELS[n][state.lang]}</option>`).join("");
    els.preset.value = state.presetName;
  }
  function applyPreset(name){
    const p=deepClone(PRESETS[name]);
    state.presetName=p.name; state.n=p.n; state.k=p.k; state.bonusCount=p.bonusCount; state.bonusPool=p.bonusPool; state.ticketPrice=p.ticketPrice; state.prizeMap=p.prizeMap||{};
    els.preset.value=name; els.maxNumber.value=state.n; els.numbersPerTicket.value=state.k; els.bonusCount.value=state.bonusCount; els.bonusPool.value=state.bonusPool; els.ticketPrice.value=state.ticketPrice;
    state.rangeMin=1; state.rangeMax=state.n; els.rangeMin.value=1; els.rangeMax.value=state.n; els.rangeMode.value="off"; state.rangeMode="off";
    renderPrizeTable(); renderTargetInputs(); persistSettings();
  }

  els.preset.addEventListener("change", ()=> applyPreset(els.preset.value));
  els.ticketPrice.addEventListener("change", ()=>{ state.ticketPrice=+els.ticketPrice.value||0; persistSettings(); });
  els.maxNumber.addEventListener("change", ()=>{ state.n=+els.maxNumber.value||0; persistSettings(); renderTargetInputs(); renderPrizeTable(); });
  els.numbersPerTicket.addEventListener("change", ()=>{ state.k=+els.numbersPerTicket.value||0; persistSettings(); renderTargetInputs(); renderPrizeTable(); });
  els.bonusCount.addEventListener("change", ()=>{ state.bonusCount=+els.bonusCount.value||0; persistSettings(); renderTargetInputs(); renderPrizeTable(); });
  els.bonusPool.addEventListener("change", ()=>{ state.bonusPool=+els.bonusPool.value||0; persistSettings(); renderTargetInputs(); renderPrizeTable(); });

  els.targetMode.addEventListener("change", ()=>{ state.targetMode=els.targetMode.value; persistSettings(); });
  els.genTarget.addEventListener("click", ()=>{ randomizeTarget(); persistSettings(); });

  els.ticketsPerDay.addEventListener("change", ()=>{ state.ticketsPerDay=+els.ticketsPerDay.value||0; persistSettings(); });
  els.totalTickets.addEventListener("change", ()=>{ state.totalTickets=+els.totalTickets.value||0; persistSettings(); updateKPI(); });
  els.changeTargetDaily.addEventListener("change", ()=>{ state.changeTargetDaily=els.changeTargetDaily.checked; persistSettings(); });

  els.rangeMin.addEventListener("change", ()=>{ state.rangeMin=+els.rangeMin.value||0; persistSettings(); });
  els.rangeMax.addEventListener("change", ()=>{ state.rangeMax=+els.rangeMax.value||0; persistSettings(); });
  els.rangeMode.addEventListener("change", ()=>{ state.rangeMode=els.rangeMode.value; persistSettings(); });

  els.resetPrizeToPreset.addEventListener("click", ()=>{ state.prizeMap=deepClone(PRESETS[state.presetName].prizeMap||{}); renderPrizeTable(); persistSettings(); });

  els.chunkSize.addEventListener("change", ()=>{ state.chunkSize=+els.chunkSize.value||0; persistSettings(); });
  els.speedMs.addEventListener("change", ()=>{ state.speedMs=+els.speedMs.value||0; persistSettings(); });
  els.stopOnJackpot.addEventListener("change", ()=>{ state.stopOnJackpot=els.stopOnJackpot.checked; persistSettings(); });

  els.logMode.addEventListener("change", ()=>{ state.logMode=els.logMode.value; persistSettings(); });
  els.logCap.addEventListener("change", ()=>{ state.logCap=+els.logCap.value||50000; persistSettings(); });
  els.displayLimit.addEventListener("change", ()=>{ state.displayLimit=+els.displayLimit.value||300; persistSettings(); renderLog(); });

  els.filterWins.addEventListener("change", ()=>{ state.winsOnlyFilter=els.filterWins.checked; renderLog(); });
  els.searchLog.addEventListener("input", ()=>{ state.searchTerm=els.searchLog.value||""; renderLog(); });

  els.startBtn.addEventListener("click", start);
  els.pauseBtn.addEventListener("click", pause);
  els.resetBtn.addEventListener("click", ()=>{ stop(true);
    state.rows.length=0; state.stats={tickets:0,days:1,jackpots:0,spent:0,paid:0,net:0,matchCounts:{}}; state.day=1; state.todayTickets=0; state.todayWins=0;
    chartReset(); updateKPI(); renderLog();
  });

  els.exportCsv.addEventListener("click", ()=>{
    if(state.rows.length===0){ toast('toast.noLog'); return; }
    download(`lotto-${state.sessionId||"session"}.csv`, toCSV());
  });
  els.saveSession.addEventListener("click", ()=>{
    const raw=localStorage.getItem(LS_SESSIONS); let obj={}; try{obj=JSON.parse(raw||"{}")}catch(e){}
    const id=state.sessionId || `manual-${Date.now()}`;
    obj[id]={ savedAt:nowIso(), presetName:state.presetName,
      settings:{ n:state.n,k:state.k,bonusCount:state.bonusCount,bonusPool:state.bonusPool,ticketPrice:state.ticketPrice, rangeMode:state.rangeMode,rangeMin:state.rangeMin,rangeMax:state.rangeMax },
      stats: deepClone(state.stats)
    };
    localStorage.setItem(LS_SESSIONS, JSON.stringify(obj)); refreshSessionsSelect(); toast('toast.saved');
  });
  els.loadSession.addEventListener("click", ()=>{
    const id=els.sessionList.value; if(!id){ return; }
    const raw=localStorage.getItem(LS_SESSIONS); let obj={}; try{obj=JSON.parse(raw||"{}")}catch(e){}
    const ss=obj[id]; if(!ss){ return; }
    state.presetName=ss.presetName; els.preset.value=state.presetName;
    const s=ss.settings||{}; state.n=s.n; state.k=s.k; state.bonusCount=s.bonusCount; state.bonusPool=s.bonusPool; state.ticketPrice=s.ticketPrice;
    state.rangeMode=s.rangeMode; state.rangeMin=s.rangeMin; state.rangeMax=s.rangeMax;
    els.maxNumber.value=state.n; els.numbersPerTicket.value=state.k; els.bonusCount.value=state.bonusCount; els.bonusPool.value=state.bonusPool; els.ticketPrice.value=state.ticketPrice;
    els.rangeMode.value=state.rangeMode; els.rangeMin.value=state.rangeMin; els.rangeMax.value=state.rangeMax;
    renderPrizeTable(); renderTargetInputs(); syncTargetInputs();
    state.stats = deepClone(ss.stats||{});
    state.day=state.stats.days||1; state.todayTickets=0; state.todayWins=0;
    chartReset(); chartAddPoint(state.stats.tickets, state.stats.net||0);
    updateKPI(); renderLog(); toast('toast.loaded');
  });
  els.clearStorage.addEventListener("click", ()=>{ localStorage.removeItem(LS_SETTINGS); localStorage.removeItem(LS_SESSIONS); refreshSessionsSelect(); toast('toast.cleared'); });

  // Keyboard shortcuts: Space = pause/resume, S = start, R = reset, T = theme, L = Lang/Dir
  window.addEventListener("keydown",(e)=>{
    if(e.key===" "){ e.preventDefault(); if(state.isRunning) pause(); }
    else if((e.key==="s"||e.key==="S")) start();
    else if((e.key==="r"||e.key==="R")) els.resetBtn.click();
    else if((e.key==="t"||e.key==="T")) els.themeToggle.click();
    else if((e.key==="l"||e.key==="L")) els.dirLangToggle.click();
  });

  // ===========================
  // Init
  // ===========================
  function init(){
    // Preset options first (labels depend on lang)
    loadPresetOptions();
    // Apply default preset then restore
    applyPreset(state.presetName);
    restoreSettings();
    // Re-apply i18n from restored language
    applyI18n();
    // Render initial UI
    renderPrizeTable(); renderTargetInputs(); updateKPI(); renderLog(); chartDraw();
    refreshSessionsSelect();
    // Placeholder localization
    els.searchLog.setAttribute("placeholder", t('log.searchPh'));
  }

  init();
})();
</script>
</body>
</html>
